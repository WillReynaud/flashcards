<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cartes Chinoises - Audio Local</title>
    <style>
        html, body {
            margin: 0; padding: 0; height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: white;
            font-family: Arial, sans-serif;
            overflow-x: visible;
        }
        body {
            flex-direction: column;
        }
        .container {
            position: relative;
            width: 400px;
            height: 400px;
            user-select: none;
        }
        .card {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            background: white;
            border: 2px solid black;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 5rem;
            z-index: 1;
        }
        .card.next {
            transform: scale(0.95);
            opacity: 0.3;
            z-index: 0;
        }
        .audio-zone {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 60px;
            height: 60px;
            background: lightgray;
            border-radius: 50%;
            z-index: 2;
            cursor: pointer;
            /* J'ai gardé les styles que j'avais ajoutés pour l'icône, au cas où tu voudrais la remettre facilement */
            /* display: flex; */
            /* justify-content: center; */
            /* align-items: center; */
            /* font-size: 2rem; */
            /* color: black; */
        }
        .buttons {
            margin-top: 30px;
            display: flex;
            gap: 40px;
        }
        button {
            width: 60px;
            height: 60px;
            font-size: 2rem;
            border-radius: 50%;
            border: 2px solid black;
            background: white;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="container" id="container">
        <div class="card current" id="cardCurrent">...</div>
        <div class="card next" id="cardNext">...</div>
        <div class="audio-zone" id="audioZone" title="Jouer l’audio"></div> </div>

    <div class="buttons">
        <button id="btnWrong" title="Je ne connais pas">✗</button>
        <button id="btnRight" title="Je connais">✓</button>
    </div>

    <script>
        const SHEET_CSV_URL = "https://docs.google.com/sheets/d/e/2PACX-1vQLhJumynOVacZQyjTJdfb2E03VOHW3FdlwYszFGHJcrOVWaihv-mrXDc3oegjTdFpJTobI1jN1nNpN/pub?gid=0&single=true&output=csv";

        let cards = [];
        let currentIndex = 0;
        let displayState = 0;

        const cardCurrent = document.getElementById("cardCurrent");
        const cardNext = document.getElementById("cardNext");
        const btnRight = document.getElementById("btnRight");
        const btnWrong = document.getElementById("btnWrong");
        const audioZone = document.getElementById("audioZone");

        let audio = new Audio();

        function parseCSV(text) {
            const lines = text.trim().split("\n");
            // Ajout du filtre pour ignorer l'en-tête et les lignes vides
            return lines.filter(line => line.trim() !== '' && !line.startsWith('character,pinyin,translation')).map(line => {
                const [character, pinyin, translation] = line.split(",");
                return {
                    character: character ? character.trim() : '',
                    pinyin: pinyin ? pinyin.trim() : '',
                    translation: translation ? translation.trim() : '',
                    familiarity: 0
                };
            });
        }

        function displayCard(index, element) {
            if (cards.length === 0) {
                element.textContent = "Aucune carte";
                return;
            }
            const card = cards[index];
            if (!card) { // Ajout d'une vérification pour un index invalide
                element.textContent = "Carte introuvable";
                return;
            }
            if (displayState === 0) {
                element.textContent = card.character;
            } else if (displayState === 1) {
                element.textContent = card.pinyin;
            } else {
                element.textContent = card.translation;
            }
        }

        function refreshCards() {
            displayState = 0;
            displayCard(currentIndex, cardCurrent);
            cardNext.textContent = "..."; // La carte suivante reste cachée
        }

        function weightedRandomIndex(cards) {
            if (cards.length === 0) return 0; // Gérer le cas où il n'y a pas de cartes
            const weights = cards.map(c => 6 - (c.familiarity || 0));
            const total = weights.reduce((a, b) => a + b, 0);
            let r = Math.random() * total;
            for (let i = 0; i < cards.length; i++) {
                if (r < weights[i]) return i;
                r -= weights[i];
            }
            return 0; // Fallback au cas où quelque chose se passerait mal
        }

        function nextCard(known) {
            if (cards.length === 0) return; // S'assurer qu'il y a des cartes avant d'avancer

            if (known) {
                cards[currentIndex].familiarity = Math.min(cards[currentIndex].familiarity + 1, 5);
            } else {
                cards[currentIndex].familiarity = Math.max(cards[currentIndex].familiarity - 1, 0);
            }
            currentIndex = weightedRandomIndex(cards);
            refreshCards();
        }

        function playAudio() {
            console.log("--- playAudio() appelée ---");
            if (cards.length === 0 || !cards[currentIndex] || !cards[currentIndex].character) {
                console.log("Pas de cartes chargées ou caractère non défini, impossible de jouer l'audio.");
                alert("Pas de carte ou de caractère défini pour l'audio.");
                return;
            }
            const character = cards[currentIndex].character;
            const audioUrl = "audios/" + encodeURIComponent(character) + ".mp3";
            console.log("URL audio essayée :", audioUrl);

            audio.src = audioUrl;
            audio.load(); // Ajouté: S'assure que le navigateur charge la nouvelle source
            audio.play().catch(err => {
                console.error("Erreur lors de la lecture de l'audio pour : " + character + " (URL: " + audioUrl + ")", err);
                alert(`Impossible de jouer l'audio pour "${character}". Vérifiez si le fichier "${character}.mp3" existe dans le dossier 'audios' et si son nom correspond.`);
            });
        }

        audioZone.addEventListener("click", playAudio);
        cardCurrent.addEventListener("click", () => {
            displayState = (displayState + 1) % 3;
            displayCard(currentIndex, cardCurrent);
        });

        btnRight.addEventListener("click", () => nextCard(true));
        btnWrong.addEventListener("click", () => nextCard(false));

        fetch(SHEET_CSV_URL)
            .then(r => {
                if (!r.ok) { // Vérifie si la réponse HTTP est OK (statut 200)
                    throw new Error(`Erreur HTTP: ${r.status} - Impossible de charger le CSV.`);
                }
                return r.text();
            })
            .then(text => {
                cards = parseCSV(text);
                if (cards.length > 0) {
                    currentIndex = weightedRandomIndex(cards);
                    refreshCards();
                    console.log("Cartes chargées avec succès ! Première carte :", cards[currentIndex]);
                } else {
                    cardCurrent.textContent = "Aucune carte trouvée dans le CSV ou erreur de parsing.";
                    console.warn("Le fichier CSV est vide ou n'a pas pu être parsé correctement.");
                }
            })
            .catch(err => {
                cardCurrent.textContent = "Erreur chargement données CSV";
                console.error("Erreur de chargement ou de traitement du CSV :", err);
            });
    </script>

</body>
</html>