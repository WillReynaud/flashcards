<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcards Mandarin</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
            overflow: hidden; /* Prevent scrollbars */
        }

        #flashcard-stack {
            width: 90vw;
            max-width: 500px;
            height: 60vh;
            max-height: 400px;
            position: relative; /* Container for stacked cards */
            display: flex; /* To center the cards within the stack */
            justify-content: center;
            align-items: center;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .flashcard {
            width: 100%;
            height: 100%;
            position: absolute; /* Stack them on top of each other */
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            background-color: #fff;
            overflow: hidden;
            transition: transform 0.3s ease-out, box-shadow 0.3s ease, opacity 0.3s ease; 
            transform-origin: center center; /* Ensure rotation around center */
        }

        /* Styles for stacked effect */
        .flashcard:nth-child(2) { 
            transform: translateY(calc(10px + 1vw)) scale(0.95);
            opacity: 0.8;
            z-index: 0; 
        }
        .flashcard:nth-child(3) { 
            transform: translateY(calc(20px + 2vw)) scale(0.90);
            opacity: 0.6;
            z-index: -1; 
        }

        .flashcard.active {
            z-index: 1; 
            cursor: grab;
        }

        .flashcard-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out; 
            color: #000; 
        }

        .flashcard-content.active-display {
            opacity: 1;
            visibility: visible;
        }

        .flashcard-front h2 {
            font-size: clamp(4em, 10vw, 8em); /* Adjusted min size for better mobile visibility */
            font-weight: bold;
        }

        .flashcard-middle h2 { /* Pinyin */
            font-size: clamp(2em, 5vw, 3em); /* Adjusted min size */
        }

        .flashcard-back h2 { /* Translation */
            font-size: clamp(1.8em, 4vw, 2.5em); /* Adjusted min size */
        }
        
        .flashcard-example h2 { /* Example */
            font-size: clamp(1.2em, 3vw, 1.8em); /* Adjusted min size */
            padding: 10px;
            line-height: 1.5;
        }


        .flashcard-content h2 {
            margin: 0;
            line-height: 1.2;
            overflow-wrap: break-word;
            word-break: break-word;
            white-space: normal;
            padding: 10px;
            color: #000; 
        }

        /* Audio zone positioned specifically for bottom-right corner and invisible */
        .audio-zone { 
            position: absolute;
            bottom: 0px; 
            right: 0px; /* Position to the right */
            width: 100px; /* Increased size for easier tapping */
            height: 100px; /* Increased size for easier tapping */
            cursor: pointer;
            z-index: 10; 
            border-top-left-radius: 15px; /* Rounded top-left corner as it's now bottom-right */
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Make icon completely transparent */
        .audio-zone::after {
            content: 'ðŸ”Š'; 
            font-size: 2em; 
            opacity: 0; /* Make it completely invisible */
        }


        #feedback {
            position: fixed;
            top: 20px;
            font-size: 1.5em;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            z-index: 100;
        }

        #feedback.show {
            opacity: 1;
        }

        #feedback.correct {
            color: #4CAF50;
            transform: translateY(0);
        }

        #feedback.incorrect {
            color: #F44336;
            transform: translateY(0);
        }

        /* --- Overlay Styles --- */
        #score-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: flex-end; /* Align modal to bottom */
            z-index: 200;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        #score-overlay.visible {
            visibility: visible;
            opacity: 1;
        }

        #score-modal {
            background-color: #fff;
            border-top-left-radius: 20px; /* Rounded top corners */
            border-top-right-radius: 20px;
            padding: 30px;
            width: 100%; /* Full width at bottom */
            max-width: 800px;
            height: 80vh; /* Takes 80% of screen height */
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden; 

            /* Initial state for slide-up animation */
            transform: translateY(100%); 
            transition: transform 0.3s ease-out;
        }

        #score-overlay.visible #score-modal {
            transform: translateY(0%); /* Slide up to visible position */
        }

        #score-modal h3 {
            text-align: center;
            margin-top: 0;
            color: #333;
            font-size: 1.8em;
            margin-bottom: 20px;
        }

        #score-columns {
            display: flex;
            flex-grow: 1; 
            gap: 20px;
            overflow-y: auto; 
        }

        .score-column {
            flex: 1;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            overflow-y: auto; 
        }

        .score-column.mastered {
            background-color: #e6ffe6; 
            border: 1px solid #4CAF50;
        }

        .score-column.medium {
            background-color: #fff8e1; 
            border: 1px solid #FFC107;
        }

        .score-column.not-mastered {
            background-color: #ffe6e6; 
            border: 1px solid #F44336;
        }

        .score-column h4 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2em;
            color: #333;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dotted #ccc;
            font-size: 1em;
        }

        .score-item:last-child {
            border-bottom: none;
        }

        .score-char {
            font-weight: bold;
            font-size: 1.1em;
        }

        .score-details {
            color: #666;
            font-size: 0.9em;
        }

        /* Home Indicator Bar */
        #home-indicator-bar {
            position: fixed;
            bottom: 8px; 
            left: 50%;
            transform: translateX(-50%);
            width: 130px; 
            height: 5px; 
            background-color: #000;
            border-radius: 100px; 
            z-index: 150; 
            cursor: pointer; 
        }

        #reset-button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            margin-top: 20px;
            align-self: center; 
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.2);
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        #reset-button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        #reset-button:active {
            background-color: #004085;
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div id="feedback"></div>
    <div id="flashcard-stack">
        </div>

    <audio id="audio-player"></audio>

    <div id="home-indicator-bar"></div>

    <div id="score-overlay">
        <div id="score-modal">
            <h3>Votre Progression</h3>
            <div id="score-columns">
                <div class="score-column not-mastered">
                    <h4>Ã€ Travailler (0-1)</h4>
                </div>
                <div class="score-column medium">
                    <h4>Ã€ Revoir (2-3)</h4>
                </div>
                <div class="score-column mastered">
                    <h4>MaÃ®trisÃ© (4-5)</h4>
                </div>
            </div>
            <button id="reset-button">RÃ©initialiser les scores</button>
        </div>
    </div>

    <script>
        const flashcardsData = [
            { char: "æˆ‘", pinyin: "wÇ’", translation: "je / moi", example: "æˆ‘æ˜¯ä¸€ä¸ªå­¦ç”Ÿ (WÇ’ shÃ¬ yÄ«gÃ¨ xuÃ©shÄ“ng) - Je suis un Ã©tudiant." },
            { char: "ä½ ", pinyin: "nÇ", translation: "tu / toi", example: "ä½ å¥½å—ï¼Ÿ (NÇ hÇŽo ma?) - Comment vas-tu ?" },
            { char: "ä»–", pinyin: "tÄ", translation: "il / lui", example: "ä»–å¾ˆé«˜ (TÄ hÄ›n gÄo) - Il est trÃ¨s grand." },
            { char: "å¥¹", pinyin: "tÄ", translation: "elle", example: "å¥¹å¾ˆæ¼‚äº® (TÄ hÄ›n piÃ oliang) - Elle est trÃ¨s belle." },
            { char: "æˆ‘ä»¬", pinyin: "wÇ’men", translation: "nous", example: "æˆ‘ä»¬åŽ»åƒé¥­ (WÇ’men qÃ¹ chÄ«fÃ n) - Nous allons manger." },
            { char: "ä½ ä»¬", pinyin: "nÇmen", translation: "vous", example: "ä½ ä»¬å¥½ï¼ (NÇmen hÇŽo!) - Bonjour Ã  vous !" },
            { char: "ä»–ä»¬", pinyin: "tÄmen", translation: "ils / eux", example: "ä»–ä»¬æ˜¯ä¸­å›½äºº (TÄmen shÃ¬ zhÅngguÃ³ rÃ©n) - Ce sont des Chinois." },
            { char: "å¥¹ä»¬", pinyin: "tÄmen", translation: "elles", example: "å¥¹ä»¬æ˜¯æœ‹å‹ (TÄmen shÃ¬ pÃ©ngyÇ’u) - Elles sont amies." },
            { char: "å§“", pinyin: "xÃ¬ng", translation: "s'appeler (nom de famille)", example: "ä½ å§“ä»€ä¹ˆï¼Ÿ (NÇ xÃ¬ng shÃ©nme?) - Comment t'appelles-tu (nom de famille) ?" },
            { char: "å«", pinyin: "jiÃ o", translation: "s'appeler (prÃ©nom)", example: "æˆ‘å«çŽ‹æ˜Ž (WÇ’ jiÃ o WÃ¡ng MÃ­ng) - Je m'appelle Wang Ming." },
            { char: "å­¦", pinyin: "xuÃ©", translation: "Ã©tudier", example: "æˆ‘å­¦æ±‰è¯­ (WÇ’ xuÃ© hÃ nyÇ”) - J'Ã©tudie le chinois." },
            { char: "æ˜¯", pinyin: "shÃ¬", translation: "Ãªtre", example: "æˆ‘æ˜¯æ³•å›½äºº (WÇ’ shÃ¬ FÃ guÃ³ rÃ©n) - Je suis franÃ§ais." },
            { char: "ç”Ÿ", pinyin: "shÄ“ng", translation: "naÃ®tre / Ã©lÃ¨ve", example: "æˆ‘çš„ç”Ÿæ—¥æ˜¯ä»Šå¤© (WÇ’ de shÄ“ngrÃ¬ shÃ¬ jÄ«n tiÄn) - Mon anniversaire est aujourd'hui." },
            { char: "æœ‰", pinyin: "yÇ’u", translation: "avoir", example: "æˆ‘æœ‰ä¸€ä¸ªè‹¹æžœ (WÇ’ yÇ’u yÄ«gÃ¨ pÃ­ngguÇ’) - J'ai une pomme." },
            { char: "è¯´", pinyin: "shuÅ", translation: "dire / parler", example: "ä½ ä¼šè¯´æ±‰è¯­å—ï¼Ÿ (NÇ huÃ¬ shuÅ hÃ nyÇ” ma?) - Sais-tu parler chinois ?" },
            { char: "åœ¨", pinyin: "zÃ i", translation: "Ãªtre (quelque part)", example: "æˆ‘åœ¨å®¶ (WÇ’ zÃ i jiÄ) - Je suis Ã  la maison." },
            { char: "åŽ»", pinyin: "qÃ¹", translation: "aller", example: "æˆ‘ä»¬åŽ»å­¦æ ¡ (WÇ’men qÃ¹ xuÃ©xiÃ o) - Nous allons Ã  l'Ã©cole." },
            { char: "æ¥", pinyin: "lÃ¡i", translation: "venir", example: "è¯·ä½ æ¥æˆ‘å®¶ (QÇng nÇ lÃ¡i wÇ’ jiÄ) - S'il te plaÃ®t, viens chez moi." },
            { char: "å›ž", pinyin: "huÃ­", translation: "revenir", example: "æˆ‘å›žå®¶äº† (WÇ’ huÃ­ jiÄ le) - Je suis rentrÃ© Ã  la maison." },
            { char: "ä½", pinyin: "zhÃ¹", translation: "habiter / demeurer", example: "ä½ ä½åœ¨å“ªé‡Œï¼Ÿ (NÇ zhÃ¹ zÃ i nÇŽlÇ?) - OÃ¹ habites-tu ?" },
            { char: "å·¥ä½œ", pinyin: "gÅngzuÃ²", translation: "travailler", example: "æˆ‘åœ¨åŒ—äº¬å·¥ä½œ (WÇ’ zÃ i BÄ›ijÄ«ng gÅngzuÃ²) - Je travaille Ã  PÃ©kin." },
            { char: "ä¼‘æ¯", pinyin: "xiÅ«xi", translation: "se reposer", example: "æˆ‘éœ€è¦ä¼‘æ¯ (WÇ’ xÅ«yÃ o xiÅ«xi) - J'ai besoin de repos." },
            { char: "æ‰¾", pinyin: "zhÇŽo", translation: "chercher", example: "æˆ‘åœ¨æ‰¾æˆ‘çš„ä¹¦ (WÇ’ zÃ i zhÇŽo wÇ’ de shÅ«) - Je cherche mon livre." },
            { char: "é—®", pinyin: "wÃ¨n", translation: "demander", example: "æˆ‘é—®ä¸€ä¸ªé—®é¢˜ (WÇ’ wÃ¨n yÄ«gÃ¨ wÃ¨ntÃ­) - Je pose une question." },
            { char: "å–", pinyin: "hÄ“", translation: "boire", example: "æˆ‘æƒ³å–èŒ¶ (WÇ’ xiÇŽng hÄ“ chÃ¡) - J'aimerais boire du thÃ©." },
            { char: "æƒ³", pinyin: "xiÃ¢ng", translation: "vouloir", example: "æˆ‘æƒ³åŽ»ä¸­å›½ (WÇ’ xiÇŽng qÃ¹ ZhÅngguÃ³) - J'aimerais aller en Chine." },
            { char: "çŸ¥é“", pinyin: "zhÄ«dÃ o", translation: "savoir", example: "æˆ‘ä¸çŸ¥é“ (WÇ’ bÃ¹ zhÄ«dÃ o) - Je ne sais pas." },
            { char: "çœ‹", pinyin: "kÃ n", translation: "voir / observer", example: "ä½ çœ‹ä»€ä¹ˆï¼Ÿ (NÇ kÃ n shÃ©nme?) - Que regardes-tu ?" },
            { char: "ä¸", pinyin: "bÃ¹", translation: "nÃ©gation", example: "æˆ‘ä¸å¥½ (WÇ’ bÃ¹ hÇŽo) - Je ne vais pas bien." },
            { char: "æ²¡", pinyin: "mÃ©i", translation: "nÃ©gation (passÃ©)", example: "æˆ‘æ²¡åŽ»è¿‡ (WÇ’ mÃ©i qÃ¹guÃ²) - Je n'y suis jamais allÃ©." },
            { char: "å‘¢", pinyin: "ne", translation: "particule interrogative", example: "ä½ å‘¢ï¼Ÿ (NÇ ne?) - Et toi ?" },
            { char: "å—", pinyin: "ma", translation: "particule interrogative", example: "ä½ æ˜¯å­¦ç”Ÿå—ï¼Ÿ (NÇ shÃ¬ xuÃ©shÄ“ng ma?) - Es-tu Ã©tudiant ?" },
            { char: "å§", pinyin: "ba", translation: "particule de suggestion", example: "æˆ‘ä»¬èµ°å§ (WÇ’men zÇ’u ba) - Allons-y." },
            { char: "ä»€ä¹ˆ", pinyin: "shÃ©nme", translation: "quoi / que", example: "è¿™æ˜¯ä»€ä¹ˆï¼Ÿ (ZhÃ¨ shÃ¬ shÃ©nme?) - Qu'est-ce que c'est ?" },
            { char: "å“ª", pinyin: "nÇŽ", translation: "quel / lequel", example: "ä½ æ˜¯å“ªå›½äººï¼Ÿ (NÇ shÃ¬ nÇŽ guÃ³ rÃ©n?) - De quel pays es-tu ?" },
            { char: "å‡ ", pinyin: "jÇ", translation: "combien (petit nombre) / quelques", example: "ä½ æœ‰å‡ æœ¬ä¹¦ï¼Ÿ (NÇ yÇ’u jÇ bÄ›n shÅ«?) - Tu as combien de livres ?" },
            { char: "è°", pinyin: "shÃ©i", translation: "qui ?", example: "ä»–æ˜¯è°ï¼Ÿ (TÄ shÃ¬ shÃ©i?) - Qui est-il ?" },
            { char: "ä¹Ÿ", pinyin: "yÄ›", translation: "aussi", example: "æˆ‘ä¹ŸåŽ» (WÇ’ yÄ› qÃ¹) - J'y vais aussi." },
            { char: "è¿™", pinyin: "zhÃ¨", translation: "ce / cette", example: "è¿™æ˜¯æˆ‘çš„ä¹¦ (ZhÃ¨ shÃ¬ wÇ’ de shÅ«) - C'est mon livre." },
            { char: "çš„", pinyin: "de", translation: "particule possessive", example: "æˆ‘çš„ç¬” (WÇ’ de bÇ) - Mon stylo." },
            { char: "ä¸ª", pinyin: "gÃ¨", translation: "classificateur gÃ©nÃ©ral", example: "ä¸€ä¸ªäºº (YÄ«gÃ¨ rÃ©n) - Une personne." },
            { char: "ä¸¤", pinyin: "liÇŽng", translation: "deux (quantitÃ©)", example: "ä¸¤ä¸ªäºº (LiÇŽng gÃ¨ rÃ©n) - Deux personnes." },
            { char: "æœ¬", pinyin: "bÄ›n", translation: "classificateur pour les livres / racine / origine / fondamentale", example: "ä¸€æœ¬ä¹¦ (YÄ« bÄ›n shÅ«) - Un livre." },
            { char: "å£", pinyin: "kÇ’u", translation: "classificateur membres famille / bouche", example: "ä¸‰å£äºº (SÄn kÇ’u rÃ©n) - Trois membres de la famille." },
            { char: "ä¸€", pinyin: "yÄ«", translation: "un", example: "ä¸€ä¸ªè‹¹æžœ (YÄ«gÃ¨ pÃ­ngguÇ’) - Une pomme." },
            { char: "äºŒ", pinyin: "Ã¨r", translation: "deux", example: "äºŒæœˆ (ÃˆryuÃ¨) - FÃ©vrier." },
            { char: "ä¸‰", pinyin: "sÄn", translation: "trois", example: "ä¸‰ä¸ªå­¦ç”Ÿ (SÄn gÃ¨ xuÃ©shÄ“ng) - Trois Ã©tudiants." },
            { char: "å››", pinyin: "sÃ¬", translation: "quatre", example: "å››ç‚¹ (SÃ¬ diÇŽn) - Quatre heures." },
            { char: "äº”", pinyin: "wÇ”", translation: "cinq", example: "äº”æœ¬ä¹¦ (WÇ” bÄ›n shÅ«) - Cinq livres." },
            { char: "å…­", pinyin: "liÃ¹", translation: "six", example: "å…­å¤© (LiÃ¹ tiÄn) - Six jours." },
            { char: "ä¸ƒ", pinyin: "qÄ«", translation: "sept", example: "ä¸ƒæœˆ (QÄ«yuÃ¨) - Juillet." },
            { char: "å…«", pinyin: "bÄ", translation: "huit", example: "å…«å² (BÄ suÃ¬) - Huit ans." },
            { char: "ä¹", pinyin: "jiÇ”", translation: "neuf", example: "ä¹ç‚¹é’Ÿ (JiÇ” diÇŽn zhÅng) - Neuf heures." },
            { char: "å", pinyin: "shÃ­", translation: "dix", example: "åä¸ªäºº (ShÃ­ gÃ¨ rÃ©n) - Dix personnes." },
            { char: "å¤šå°‘", pinyin: "duÅshÇŽo", translation: "combien ?", example: "ä½ æœ‰å¤šå°‘é’±ï¼Ÿ (NÇ yÇ’u duÅshÇŽo qiÃ¡n?) - Combien d'argent as-tu ?" },
            { char: "å¤šå¤§", pinyin: "duÅ dÃ ", translation: "quel Ã¢ge ?", example: "ä½ å¤šå¤§äº†ï¼Ÿ (NÇ duÅ dÃ  le?) - Quel Ã¢ge as-tu ?" },
            { char: "å²", pinyin: "suÃ¬", translation: "Ã¢ge", example: "æˆ‘åå…«å² (WÇ’ shÃ­bÄ suÃ¬) - J'ai dix-huit ans." },
            { char: "å‡ å²", pinyin: "jÇ suÃ¬", translation: "Pour les enfants (moins de 10 ans)", example: "ä½ å‡ å²äº†ï¼Ÿ (NÇ jÇ suÃ¬ le?) - Quel Ã¢ge as-tu (enfant) ?" },
            { char: "æ‚¨å¤šå¤§å¹´çºª", pinyin: "NÃ­n duÅ dÃ  niÃ¡njÃ¬ ?", translation: "Pour Ãªtre poli avec des personnes Ã¢gÃ©es", example: "æ‚¨å¤šå¤§å¹´çºªäº†ï¼Ÿ (NÃ­n duÅ dÃ  niÃ¡njÃ¬ le?) - Quel Ã¢ge avez-vous (poli) ?" },
            { char: "åœ¨", pinyin: "zÃ i", translation: "Ãªtre (quelque part)", example: "æˆ‘åœ¨å®¶ (WÇ’ zÃ i jiÄ) - Je suis Ã  la maison." },
            { char: "å“ªå„¿", pinyin: "nÇŽr", translation: "oÃ¹", example: "ä½ åŽ»å“ªå„¿ï¼Ÿ (NÇ qÃ¹ nÇŽr?) - OÃ¹ vas-tu ?" },
            { char: "å¹´", pinyin: "niÃ¡n", translation: "annÃ©e", example: "ä»Šå¹´æ˜¯äºŒé›¶äºŒäº”å¹´ (JÄ«nniÃ¡n shÃ¬ Ã¨r lÃ­ng Ã¨r wÇ” niÃ¡n) - Cette annÃ©e est 2025." },
            { char: "æ˜ŸæœŸ", pinyin: "xÄ«ngqÄ«", translation: "semaine", example: "ä¸€ä¸ªæ˜ŸæœŸ (YÄ«gÃ¨ xÄ«ngqÄ«) - Une semaine." },
            { char: "æ—¥", pinyin: "rÃ¬", translation: "jour", example: "ä»Šå¤©æ˜¯æ˜ŸæœŸæ—¥ (JÄ«ntiÄn shÃ¬ xÄ«ngqÄ«rÃ¬) - Aujourd'hui est dimanche." },
            { char: "å·", pinyin: "hÃ o", translation: "jour/date (oral)", example: "åæœˆä¸€å· (ShÃ­ yuÃ¨ yÄ« hÃ o) - Le 1er octobre." },
            { char: "æœˆ", pinyin: "yuÃ¨", translation: "mois", example: "ä¸‰æœˆ (SÄnyuÃ¨) - Mars." },
            { char: "æ˜ŸæœŸæ—¥", pinyin: "xÄ«ngqÄ«rÃ¬", translation: "dimanche", example: "æ˜ŸæœŸæ—¥ä¼‘æ¯ (XÄ«ngqÄ«rÃ¬ xiÅ«xi) - Se reposer le dimanche." },
            { char: "ç”Ÿæ—¥", pinyin: "shÄ“ngrÃ¬", translation: "anniversaire", example: "ç¥ä½ ç”Ÿæ—¥å¿«ä¹ (ZhÃ¹ nÇ shÄ“ngrÃ¬ kuÃ ilÃ¨) - Joyeux anniversaire." },
            { char: "å‡ ", pinyin: "jÇ", translation: "combien (petit nombre / heure / Ã¢ge)", example: "çŽ°åœ¨å‡ ç‚¹äº†ï¼Ÿ (XiÃ nzÃ i jÇ diÇŽn le?) - Quelle heure est-il maintenant ?" },
            { char: "ä»Šå¤©", pinyin: "jÄ«ntiÄn", translation: "aujourd'hui", example: "ä»Šå¤©å¤©æ°”å¾ˆå¥½ (JÄ«ntiÄn tiÄnqÃ¬ hÄ›n hÇŽo) - Il fait beau aujourd'hui." },
            { char: "æ˜Žå¤©", pinyin: "mÃ­ngtiÄn", translation: "demain", example: "æ˜Žå¤©è§ (MÃ­ngtiÄn jiÃ n) - Ã€ demain." },
            { char: "æ˜¨å¤©", pinyin: "zuÃ³tiÄnhier", translation: "hier", example: "æ˜¨å¤©æˆ‘æ²¡åŽ» (ZuÃ³tiÄn wÇ’ mÃ©i qÃ¹) - Je n'y suis pas allÃ© hier." },
            { char: "ä¸Šåˆ", pinyin: "shÃ ngwÇ”", translation: "matin", example: "ä¸Šåˆå¥½ (ShÃ ngwÇ” hÇŽo) - Bonjour (matin)." },
            { char: "ä¸­åˆ", pinyin: "zhÅngwÇ”", translation: "midi", example: "ä¸­åˆåƒé¥­ (ZhÅngwÇ” chÄ«fÃ n) - Manger Ã  midi." },
            { char: "ä¸‹åˆ", pinyin: "xiÃ wÇ”", translation: "xiÃ wÇ”", example: "ä¸‹åˆåŽ»å…¬å›­ (XiÃ wÇ” qÃ¹ gÅngyuÃ¡n) - Aller au parc l'aprÃ¨s-midi." },
            { char: "æ—©ä¸Š", pinyin: "zÇŽoshang", translation: "matin (trÃ¨s tÃ´t)", example: "æ—©ä¸Šå¥½ (ZÇŽoshang hÇŽo) - Bonjour (trÃ¨s tÃ´t le matin)." },
            { char: "æ™šä¸Š", pinyin: "wÇŽnshang", translation: "soir", example: "æ™šä¸Šå¥½ (WÇŽnshang hÇŽo) - Bonsoir." },
            { char: "ä»Šå¹´", pinyin: "jÄ«nniÃ¡n", translation: "cette annÃ©e", example: "æˆ‘ä»Šå¹´ä¸‰åå² (WÇ’ jÄ«nniÃ¡n sÄnshÃ­ suÃ¬) - J'ai trente ans cette annÃ©e." },
            { char: "æ˜Žå¹´", pinyin: "mÃ­ngniÃ¡n", translation: "l'annÃ©e prochaine", example: "æ˜Žå¹´å†è§ (MÃ­ngniÃ¡n zÃ ijiÃ n) - Ã€ l'annÃ©e prochaine." },
            { char: "åŽ»å¹´", pinyin: "qÃ¹niÃ¡n", translation: "l'annÃ©e derniÃ¨re", example: "åŽ»å¹´æˆ‘åŽ»äº†æ—¥æœ¬ (QÃ¹niÃ¡n wÇ’ qÃ¹ le RÃ¬bÄ›n) - L'annÃ©e derniÃ¨re, je suis allÃ© au Japon." },
            { char: "é’Ÿ", pinyin: "zhÅng", translation: "horloge / utilisÃ© pour l'heure prÃ©cise", example: "ä¸‰ç‚¹é’Ÿ (SÄn diÇŽn zhÅng) - Trois heures prÃ©cises." },
            { char: "ç‚¹", pinyin: "diÇŽn", translation: "point / unitÃ© de compte pour l'heure", example: "çŽ°åœ¨äº”ç‚¹ (XiÃ nzÃ i wÇ” diÇŽn) - Il est cinq heures." },
            { char: "åˆ†", pinyin: "fÄ“n", translation: "minute", example: "ååˆ†é’Ÿ (ShÃ­ fÄ“nzhÅng) - Dix minutes." },
            { char: "åˆ»", pinyin: "kÃ¨", translation: "quart d'heure", example: "ä¸¤ç‚¹ä¸€åˆ» (LiÇŽng diÇŽn yÄ« kÃ¨) - Deux heures et quart." },
            { char: "åŠ", pinyin: "bÃ n", translation: "demi (30 minutes)", example: "ä¸‰ç‚¹åŠ (SÄn diÇŽn bÃ n) - Trois heures et demie." },
            { char: "ä¸‰ç‚¹é’Ÿ", pinyin: "sÄn diÇŽn zhÅng", translation: "3 heures", example: "ç«è½¦ä¸‰ç‚¹é’Ÿå¼€ (HuÇ’chÄ“ sÄn diÇŽn zhÅng kÄi) - Le train part Ã  trois heures." },
            { char: "ä¸‰ç‚¹äº”åˆ†", pinyin: "sÄn diÇŽn wÇ” fÄ“n", translation: "3h05", example: "ä¼šè®®ä¸‰ç‚¹äº”åˆ†å¼€å§‹ (HuÃ¬yÃ¬ sÄn diÇŽn wÇ” fÄ“n kÄishÇ) - La rÃ©union commence Ã  3h05." },
            { char: "å…­ç‚¹ä¸€åˆ»", pinyin: "liÃ¹ diÇŽn yÄ« kÃ¨", translation: "6h15", example: "æˆ‘ä»¬å…­ç‚¹ä¸€åˆ»è§é¢ (WÇ’men liÃ¹ diÇŽn yÄ« kÃ¨ jiÃ nmiÃ n) - On se voit Ã  6h15." },
            { char: "å…­ç‚¹åŠ", pinyin: "liÃ¹ diÇŽn bÃ n", translation: "6h30", example: "å¥¹å…­ç‚¹åŠå›žå®¶ (TÄ liÃ¹ diÇŽn bÃ n huÃ­ jiÄ) - Elle rentre Ã  6h30." },
            { char: "ä¸ƒç‚¹å·®ä¸€åˆ»", pinyin: "qÄ« diÇŽn chÃ  yÄ« kÃ¨", translation: "6h45", example: "çŽ°åœ¨ä¸ƒç‚¹å·®ä¸€åˆ» (XiÃ nzÃ i qÄ« diÇŽn chÃ  yÄ« kÃ¨) - Il est 6h45 maintenant." },
            { char: "å…­ç‚¹ä¸‰åˆ»", pinyin: "liÃ¹ diÇŽn sÄn kÃ¨", translation: "6h45 (alternative)", example: "ä»–å…­ç‚¹ä¸‰åˆ»åˆ° (TÄ liÃ¹ diÇŽn sÄn kÃ¨ dÃ o) - Il arrive Ã  6h45." },
            { char: "å¥½", pinyin: "hÇŽo", translation: "bien", example: "æˆ‘å¾ˆå¥½ (WÇ’ hÄ›n hÇŽo) - Je vais trÃ¨s bien." },
            { char: "å¤§", pinyin: "dÃ ", translation: "grand", example: "è¿™ä¸ªæˆ¿å­å¾ˆå¤§ (ZhÃ¨ge fÃ¡ngzi hÄ›n dÃ ) - Cette maison est trÃ¨s grande." },
            { char: "å°", pinyin: "xiÇŽo", translation: "petit", example: "æˆ‘çš„ç‹—å¾ˆå° (WÇ’ de gÇ’u hÄ›n xiÇŽo) - Mon chien est petit." },
            { char: "è€", pinyin: "lÇŽo", translation: "vieux", example: "ä»–æ˜¯ä¸€ä¸ªè€æœ‹å‹ (TÄ shÃ¬ yÄ«gÃ¨ lÇŽo pÃ©ngyÇ’u) - C'est un vieil ami." },
            { char: "è¿‡", pinyin: "guÃ²", translation: "(passÃ© d'expÃ©rience)", example: "æˆ‘åŽ»è¿‡ä¸­å›½ (WÇ’ qÃ¹guÃ² ZhÅngguÃ³) - Je suis allÃ© en Chine (expÃ©rience)." },
            { char: "åå­—", pinyin: "mÃ­ngzi", translation: "prÃ©nom", example: "ä½ çš„åå­—æ˜¯ä»€ä¹ˆï¼Ÿ (NÇ de mÃ­ngzi shÃ¬ shÃ©nme?) - Quel est ton prÃ©nom ?" },
            { char: "å§“", pinyin: "xÃ¬ng", translation: "nom de famille", example: "ä»–å§“æŽ (TÄ xÃ¬ng LÇ) - Son nom de famille est Li." },
            { char: "äºº", pinyin: "rÃ©n", translation: "personne", example: "ä¸­å›½äºº (ZhÅngguÃ³ rÃ©n) - Personne chinoise / Chinois." },
            { char: "è¿™ä¸ªäºº", pinyin: "zhÃ¨ ge rÃ©n", translation: "cette personne-ci", example: "è¿™ä¸ªäººæ˜¯è°ï¼Ÿ (ZhÃ¨ge rÃ©n shÃ¬ shÃ©i?) - Qui est cette personne ?" },
            { char: "é‚£ä¸ªäºº", pinyin: "nÃ  ge rÃ©n", translation: "cette personne-lÃ ", example: "é‚£ä¸ªäººæ˜¯æˆ‘çš„è€å¸ˆ (NÃ gÃ¨ rÃ©n shÃ¬ wÇ’ de lÇŽoshÄ«) - Cette personne-lÃ  est mon professeur." },
            { char: "éƒ½", pinyin: "dÅu", translation: "tous / tout", example: "æˆ‘ä»¬éƒ½æ˜¯å­¦ç”Ÿ (WÇ’men dÅu shÃ¬ xuÃ©shÄ“ng) - Nous sommes tous Ã©tudiants." },
            { char: "æœ‹å‹", pinyin: "pÃ©ngyÇ’u", translation: "ami", example: "ä»–æ˜¯æˆ‘çš„å¥½æœ‹å‹ (TÄ shÃ¬ wÇ’ de hÇŽo pÃ©ngyÇ’u) - C'est mon bon ami." },
            { char: "ç”·æœ‹å‹", pinyin: "nÃ¡n pÃ©ngyÇ’u", translation: "petit ami", example: "elle a un petit ami" },
            { char: "å¥³æœ‹å‹", pinyin: "nÇš pÃ©ngyÇ’u", translation: "petite amie", example: "il a une petite amie" },
            { char: "å§å§", pinyin: "jiÄ›jie", translation: "grande sÅ“ur", example: "æˆ‘æœ‰ä¸€ä¸ªå§å§ (WÇ’ yÇ’u yÄ«gÃ¨ jiÄ›jie) - J'ai une grande sÅ“ur." },
            { char: "å¦¹å¦¹", pinyin: "mÃ¨imei", translation: "petite sÅ“ur", example: "æˆ‘çš„å¦¹å¦¹å¾ˆå¯çˆ± (WÇ’ de mÃ¨imei hÄ›n kÄ›'Ã i) - Ma petite sÅ“ur est trÃ¨s mignonne." },
            { char: "å“¥å“¥", pinyin: "gÄ“ge", translation: "grand frÃ¨re", example: "æˆ‘æ²¡æœ‰å“¥å“¥ (WÇ’ mÃ©iyÇ’u gÄ“ge) - Je n'ai pas de grand frÃ¨re." },
            { char: "å¼Ÿå¼Ÿ", pinyin: "dÃ¬di", translation: "petit frÃ¨re", example: "ä»–æ˜¯æˆ‘å¼Ÿå¼Ÿ (TÄ shÃ¬ wÇ’ dÃ¬di) - C'est mon petit frÃ¨re." },
            { char: "çˆ¸çˆ¸", pinyin: "bÃ ba", translation: "papa", example: "æˆ‘çˆ±çˆ¸çˆ¸å¦ˆå¦ˆ (WÇ’ Ã i bÃ ba mÄmÄ) - J'aime papa et maman." },
            { char: "å¦ˆå¦ˆ", pinyin: "mÄmÄ", translation: "maman", example: "æˆ‘å¦ˆå¦ˆåœ¨å®¶ (WÇ’ mÄma zÃ i jiÄ) - Ma maman est Ã  la maison." },
            { char: "å­©å­", pinyin: "hÃ¡izi", translation: "enfant", example: "å¥¹æœ‰ä¸¤ä¸ªå­©å­ (TÄ yÇ’u liÇŽng gÃ¨ hÃ¡izi) - Elle a deux enfants." },
            { char: "çˆ¶æ¯", pinyin: "fÃ¹mÇ”", translation: "parents", example: "æˆ‘çš„çˆ¶æ¯æ˜¯ä¸­å›½äºº (WÇ’ de fÃ¹mÇ” shÃ¬ zhÅngguÃ³ rÃ©n) - Mes parents sont chinois." },
            { char: "å­¦ç”Ÿ", pinyin: "xuÃ©shÄ“ng", translation: "Ã©tudiant", example: "ä»–æ˜¯ä¸€åå­¦ç”Ÿ (TÄ shÃ¬ yÄ« mÃ­ng xuÃ©shÄ“ng) - C'est un Ã©tudiant." },
            { char: "å¤§å­¦ç”Ÿ", pinyin: "dÃ xuÃ©shÄ“ng", translation: "Ã©tudiant (supÃ©rieur)", example: "ä»–æ˜¯ä¸€ä¸ªå¤§å­¦ç”Ÿ (TÄ shÃ¬ yÄ«gÃ¨ dÃ xuÃ©shÄ“ng) - C'est un Ã©tudiant universitaire." },
            { char: "ä¸­å­¦ç”Ÿ", pinyin: "zhÅngxuÃ©shÄ“ng", translation: "Ã©lÃ¨ve du secondaire", example: "æˆ‘çš„è¡¨å¼Ÿæ˜¯ä¸­å­¦ç”Ÿ (WÇ’ de biÇŽodÃ¬ shÃ¬ zhÅngxuÃ©shÄ“ng) - Mon cousin est Ã©lÃ¨ve au collÃ¨ge/lycÃ©e." },
            { char: "å°å­¦ç”Ÿ", pinyin: "xiÇŽoxuÃ©shÄ“ng", translation: "Ã©lÃ¨ve du primaire", example: "elle est une Ã©lÃ¨ve de primaire" },
            { char: "åšå£«", pinyin: "bÃ³shÃ¬", translation: "docteur (titre acadÃ©mique)", example: "il est docteur (PhD)" },
            { char: "æ±‰è¯­", pinyin: "hÃ nyÇ”", translation: "langue chinoise", example: "j'apprends le chinois" },
            { char: "æ—¥è¯­", pinyin: "rÃ¬yÇ”", translation: "langue japonaise", example: "Parles-tu japonais ?" },
            { char: "æ³•è¯­", pinyin: "fÇŽyÇ”", translation: "langue franÃ§aise", example: "Je viens de France, donc je parle franÃ§ais." },
            { char: "è‹±è¯­", pinyin: "yÄ«ngyÇ”", translation: "langue anglaise", example: "Son anglais est trÃ¨s bon." },
            { char: "å¾·è¯­", pinyin: "dÃ©yÇ”", translation: "langue allemande", example: "Je ne parle pas allemand." },
            { char: "æ–‡", pinyin: "wÃ©n", translation: "Ã©criture / langue", example: "ä¸­æ–‡ (ZhÅngwÃ©n) - Langue chinoise (Ã©crite)." },
            { char: "åŽ†å²", pinyin: "lÃ¬shÇ", translation: "histoire", example: "J'aime l'histoire." },
            { char: "è‰ºæœ¯", pinyin: "yÃ¬shÃ¹", translation: "art", example: "Elle Ã©tudie l'art." },
            { char: "æ–‡å­¦", pinyin: "wÃ©nxuÃ©", translation: "littÃ©rature", example: "Il est trÃ¨s intÃ©ressÃ© par la littÃ©rature." },
            { char: "æ•°å­¦", pinyin: "shÃ¹xuÃ©", translation: "mathÃ©matiques", example: "Les mathÃ©matiques sont difficiles." },
            { char: "ä¸­å›½", pinyin: "zhÅngguÃ³", translation: "Chine", example: "J'aime la Chine." },
            { char: "åŒ—äº¬", pinyin: "bÄ›ijÄ«ng", translation: "PÃ©kin", example: "Je suis allÃ© Ã  PÃ©kin." },
            { char: "æ³•å›½", pinyin: "fÇŽguÃ³", translation: "France", example: "Je suis franÃ§ais." },
            { char: "è½¦", pinyin: "chÄ“", translation: "vÃ©hicule", example: "Cette voiture est trÃ¨s belle." },
            { char: "æ±½è½¦", pinyin: "qÃ¬chÄ“", translation: "voiture", example: "Il a une voiture." },
            { char: "è‡ªè¡Œè½¦", pinyin: "zÃ¬xÃ­ngchÄ“", translation: "vÃ©lo", example: "Je vais au travail Ã  vÃ©lo." },
            { char: "å›½", pinyin: "guÃ³", translation: "pays", example: "Quel est ton pays ?" },
            { char: "äººå£", pinyin: "rÃ©nkÇ’u", translation: "population", example: "La population chinoise est trÃ¨s nombreuse." },
            { char: "åŒ—æ–¹äºº", pinyin: "bÄ›ifÄngrÃ©n", translation: "gens du nord", example: "Je suis du nord (de la Chine)." },
            { char: "å—æ–¹äºº", pinyin: "nÃ¡nfÄngrÃ©n", translation: "gens du sud", example: "Il est du sud (de la Chine)." },
            { char: "ä¸­", pinyin: "zhÅng", translation: "au centre / milieu", example: "ä¸­é—´ (ZhÅngjiÄn) - Au milieu." },
            { char: "åŒ—", pinyin: "bÄ›i", translation: "nord", example: "PÃ©kin est au nord." },
            { char: "å—", pinyin: "nÃ¡n", translation: "sud", example: "Le sud est trÃ¨s chaud." },
            { char: "ä¸œ", pinyin: "dÅng", translation: "est", example: "ä¸œæ–¹ (DÅngfÄng) - L'Est." },
            { char: "è¥¿", pinyin: "xÄ«", translation: "ouest", example: "è¥¿æ–¹æ–‡åŒ– (XÄ«fÄng wÃ©nhuÃ ) - Culture occidentale." },
            { char: "èŒ¶", pinyin: "chÃ¡", translation: "thÃ©", example: "S'il vous plaÃ®t, buvez du thÃ©." },
            { char: "æ˜¯", pinyin: "shÃ¬", translation: "Oui", example: "Oui, c'est Ã§a." },
            { char: "ä¸", pinyin: "bÃ¹", translation: "non", example: "Non, ce n'est pas juste." },
            { char: "çº¢", pinyin: "hÃ³ng", translation: "rouge", example: "çº¢è‰² (HÃ³ngsÃ¨) - Couleur rouge." },
            { char: "ç»¿", pinyin: "lÃ¼", translation: "Vert", example: "ç»¿è‰² (LÇœsÃ¨) - Couleur verte." },
            { char: "å¥¶", pinyin: "nÇŽi", translation: "lait", example: "ç‰›å¥¶ (NiÃºnÇŽi) - Lait de vache." }
        ];

        let cardScores = new Array(flashcardsData.length).fill(2); 
        const INITIAL_SCORE = 2; 
        const SCORE_MAX = 5;
        const SCORE_MIN = 0;
        const NUM_CARDS_IN_STACK = 3; 
        const NUM_DISPLAY_STAGES = 4; // Char, Pinyin, Translation, Example

        const flashcardStack = document.getElementById('flashcard-stack');
        const audioPlayer = document.getElementById('audio-player');
        const feedbackDisplay = document.getElementById('feedback');
        const scoreOverlay = document.getElementById('score-overlay');
        const homeIndicatorBar = document.getElementById('home-indicator-bar');
        const resetButton = document.getElementById('reset-button');
        
        let cardDataQueue = []; 

        function showFeedback(message, type) {
            feedbackDisplay.textContent = message;
            feedbackDisplay.className = 'show ' + type;
            setTimeout(() => {
                feedbackDisplay.className = '';
            }, 1000);
        }

        function getWeightedRandomCardIndex() {
            let weightedIndexes = [];
            for (let i = 0; i < flashcardsData.length; i++) {
                const weight = SCORE_MAX - cardScores[i] + 1;
                for (let j = 0; j < weight; j++) {
                    weightedIndexes.push(i);
                }
            }
            if (weightedIndexes.length === 0 && flashcardsData.length > 0) {
                 return Math.floor(Math.random() * flashcardsData.length);
            } else if (flashcardsData.length === 0) {
                return -1;
            }
            const randomIndex = Math.floor(Math.random() * weightedIndexes.length);
            return weightedIndexes[randomIndex];
        }

        function fillCardQueue() {
            while (cardDataQueue.length < NUM_CARDS_IN_STACK + 1) { 
                let newIndex = getWeightedRandomCardIndex();
                if (newIndex !== -1) {
                    const displayedCardDataIndices = Array.from(flashcardStack.children).map(cardEl => parseInt(cardEl.dataset.cardDataIndex));
                    // Check if the new index is already in the current stack or in the queue to avoid duplicates right away
                    if (!displayedCardDataIndices.includes(newIndex) && !cardDataQueue.includes(newIndex)) {
                        cardDataQueue.push(newIndex);
                    } else {
                        // If it's a duplicate, try to find another unique card
                        let foundUnique = false;
                        for(let i = 0; i < flashcardsData.length; i++) {
                            if (!displayedCardDataIndices.includes(i) && !cardDataQueue.includes(i)) {
                                newIndex = i; // Found a unique index
                                cardDataQueue.push(newIndex);
                                foundUnique = true;
                                break;
                            }
                        }
                        if (!foundUnique && flashcardsData.length > 0) { // If no unique card left, allow duplicates if needed to fill stack
                            cardDataQueue.push(newIndex); 
                        } else if (flashcardsData.length === 0) {
                             console.warn("No cards available in flashcardsData.");
                             break;
                        }
                    }
                } else {
                    console.warn("No more cards to add to queue.");
                    break;
                }
            }
        }


        function createFlashcardElement(cardDataIndex, domIndex) {
            const flashcardDiv = document.createElement('div');
            flashcardDiv.classList.add('flashcard');
            flashcardDiv.id = `flashcard-${domIndex}`;
            flashcardDiv.dataset.cardDataIndex = cardDataIndex; 

            const cardContents = ['front', 'middle', 'back', 'example'];
            const cardValues = [
                flashcardsData[cardDataIndex].char,
                flashcardsData[cardDataIndex].pinyin,
                flashcardsData[cardDataIndex].actualTranslation || flashcardsData[cardDataIndex].translation, // Use actualTranslation if available
                flashcardsData[cardDataIndex].example 
            ];

            cardContents.forEach((type, i) => {
                const contentDiv = document.createElement('div');
                contentDiv.classList.add('flashcard-content', `flashcard-${type}`);
                contentDiv.id = `card-${domIndex}-${type}`;
                const h2 = document.createElement('h2');
                h2.textContent = cardValues[i];
                contentDiv.appendChild(h2);
                flashcardDiv.appendChild(contentDiv);
            });

            const audioZoneDiv = document.createElement('div');
            audioZoneDiv.classList.add('audio-zone'); 
            flashcardDiv.appendChild(audioZoneDiv);

            return flashcardDiv;
        }

        function initializeCardStack() {
            fillCardQueue();
            flashcardStack.innerHTML = ''; 
            for (let i = 0; i < NUM_CARDS_IN_STACK; i++) {
                if (cardDataQueue.length > i) {
                    const cardElement = createFlashcardElement(cardDataQueue[i], i);
                    flashcardStack.appendChild(cardElement);
                }
            }
            // Ensure at least one card is in the stack before trying to set active
            if (flashcardStack.children.length > 0) {
                flashcardStack.children[0].classList.add('active');
                updateDisplayStage(flashcardStack.children[0], 0); 
            }
            applyStackStyles(); // Apply initial stack styles after cards are added
            addEventListenersToActiveCard();
        }

        function swipeCard(direction, onComplete) {
            const activeCard = flashcardStack.querySelector('.flashcard.active');
            if (!activeCard) {
                if (onComplete) onComplete(); 
                return;
            }

            removeEventListenersFromActiveCard(); 

            const swipedCardDataIndex = parseInt(activeCard.dataset.cardDataIndex);

            activeCard.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out'; 
            let rotation = direction === 'right' ? 'rotate(10deg)' : 'rotate(-10deg)';
            let translateX = direction === 'right' ? '150%' : '-150%';
            activeCard.style.transform = `translateX(${translateX}) translateY(0) ${rotation}`;
            activeCard.style.opacity = '0';
            activeCard.classList.remove('active');

            if (swipedCardDataIndex !== undefined && swipedCardDataIndex !== -1) {
                 if (direction === 'right') {
                    if (cardScores[swipedCardDataIndex] < SCORE_MAX) cardScores[swipedCardDataIndex]++;
                    showFeedback('Bravo !', 'correct');
                 } else { 
                    if (cardScores[swipedCardDataIndex] > SCORE_MIN) cardScores[swipedCardDataIndex]--;
                    showFeedback('Ã€ revoir !', 'incorrect');
                 }
            }
            
            activeCard.addEventListener('transitionend', () => {
                activeCard.remove(); 

                cardDataQueue.shift(); 
                fillCardQueue(); 

                // Add new card at the end of the visual stack
                if (cardDataQueue.length > NUM_CARDS_IN_STACK - 1) { 
                    const newCardDataIndex = cardDataQueue[NUM_CARDS_IN_STACK - 1]; 
                    const newCardElement = createFlashcardElement(newCardDataIndex, flashcardStack.children.length); 
                    flashcardStack.appendChild(newCardElement);
                } else if (flashcardsData.length > 0 && cardDataQueue.length === 0) {
                     fillCardQueue(); 
                     if (cardDataQueue.length > 0) {
                        const newCardDataIndex = cardDataQueue[0]; 
                        const newCardElement = createFlashcardElement(newCardDataIndex, flashcardStack.children.length);
                        flashcardStack.appendChild(newCardElement);
                     }
                }


                applyStackStyles(); 
                if (onComplete) onComplete();

            }, { once: true });
        }

        function applyStackStyles() {
            const cards = flashcardStack.children;
            for (let i = 0; i < cards.length; i++) {
                cards[i].style.transition = 'transform 0.2s ease-out, opacity 0.2s ease-out, box-shadow 0.3s ease'; 
                cards[i].style.opacity = '1'; 

                cards[i].style.transform = ''; 
                cards[i].classList.remove('active'); 

                if (i === 0) {
                    cards[i].style.transform = 'translateY(0) scale(1)'; 
                    cards[i].classList.add('active');
                    updateDisplayStage(cards[i], 0); // Always reset to stage 0 for new active card
                } else if (i === 1) {
                    cards[i].style.transform = 'translateY(calc(10px + 1vw)) scale(0.95)';
                } else if (i === 2) {
                    cards[i].style.transform = 'translateY(calc(20px + 2vw)) scale(0.90)';
                } else {
                    cards[i].style.transform = 'translateY(calc(30px + 3vw)) scale(0.85)';
                    cards[i].style.opacity = '0'; 
                }
            }
            addEventListenersToActiveCard(); 
        }


        function updateDisplayStage(cardElement, stage) {
            const contentElements = Array.from(cardElement.querySelectorAll('.flashcard-content'));
            contentElements.forEach((el, idx) => {
                if (idx === stage) {
                    el.classList.add('active-display');
                } else {
                    el.classList.remove('active-display');
                }
            });
            cardElement.dataset.currentDisplayStage = stage;
        }

        let currentCardListeners = {}; 
        let isDragging = false; 
        let startX = 0;
        let startY = 0;
        let initialTransform = '';
        let isTap = true; 
        const tapThreshold = 10; 

        function addEventListenersToActiveCard() {
            const activeCard = flashcardStack.querySelector('.flashcard.active');
            if (!activeCard) return;

            removeEventListenersFromActiveCard(); 

            // --- Mouse Events ---
            const mousedownHandler = (e) => {
                if (e.button === 0) { 
                    isDragging = true;
                    isTap = true; 
                    startX = e.clientX;
                    startY = e.clientY;
                    initialTransform = activeCard.style.transform; 
                    activeCard.style.transition = 'none'; 
                    activeCard.style.cursor = 'grabbing';
                    e.preventDefault(); 
                    document.addEventListener('mousemove', mousemoveHandler);
                    document.addEventListener('mouseup', globalMouseupHandler);
                }
            };
            activeCard.addEventListener('mousedown', mousedownHandler);
            currentCardListeners.mousedown = mousedownHandler;

            const mousemoveHandler = (e) => {
                if (!isDragging) return;
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;

                if (Math.abs(deltaX) > tapThreshold || Math.abs(deltaY) > tapThreshold) {
                    isTap = false;
                }

                const rotation = deltaX / (window.innerWidth / 2) * 20; 
                activeCard.style.transform = `translate(${deltaX}px, ${deltaY}px) rotate(${rotation}deg)`;

                if (deltaX > 50) {
                    activeCard.style.boxShadow = '0 10px 30px rgba(76, 175, 80, 0.4)';
                } else if (deltaX < -50) {
                    activeCard.style.boxShadow = '0 10px 30px rgba(244, 67, 54, 0.4)';
                } else {
                    activeCard.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.1)';
                }
            };
            // Event listener is added on mousedown and removed on mouseup

            const globalMouseupHandler = (e) => { 
                if (!isDragging) return;
                isDragging = false;
                document.removeEventListener('mousemove', mousemoveHandler); 
                document.removeEventListener('mouseup', globalMouseupHandler); 

                activeCard.style.transition = 'transform 0.3s ease-out, box-shadow 0.3s ease'; 
                activeCard.style.cursor = 'grab';
                activeCard.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.1)';

                const deltaX = e.clientX - startX;
                const swipeThreshold = 100; 

                if (!isTap && Math.abs(deltaX) > swipeThreshold) { 
                    const direction = deltaX > 0 ? 'right' : 'left';
                    swipeCard(direction);
                } else if (isTap) { 
                    handleCardInteraction(e);
                } else {
                    activeCard.style.transform = initialTransform; 
                }
            };

            // --- Touch Events ---
            const touchstartHandler = (e) => {
                if (e.touches.length === 1) { 
                    isDragging = true;
                    isTap = true; 
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                    initialTransform = activeCard.style.transform;
                    activeCard.style.transition = 'none';
                    document.addEventListener('touchmove', touchmoveHandler, { passive: false });
                    document.addEventListener('touchend', globalTouchendHandler);
                    document.addEventListener('touchcancel', globalTouchendHandler);
                }
            };
            activeCard.addEventListener('touchstart', touchstartHandler);
            currentCardListeners.touchstart = touchstartHandler;

            const touchmoveHandler = (e) => {
                if (!isDragging || e.touches.length === 0) return; 
                const deltaX = e.touches[0].clientX - startX;
                const deltaY = e.touches[0].clientY - startY;

                // Only prevent default if a significant movement (not just a tap) is detected
                if (Math.abs(deltaX) > tapThreshold || Math.abs(deltaY) > tapThreshold) {
                    isTap = false;
                    e.preventDefault(); 
                }

                const rotation = deltaX / (window.innerWidth / 2) * 20;
                activeCard.style.transform = `translate(${deltaX}px, ${deltaY}px) rotate(${rotation}deg)`;

                if (deltaX > 50) {
                    activeCard.style.boxShadow = '0 10px 30px rgba(76, 175, 80, 0.4)';
                } else if (deltaX < -50) {
                    activeCard.style.boxShadow = '0 10px 30px rgba(244, 67, 54, 0.4)';
                } else {
                    activeCard.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.1)';
                }
            };

            const globalTouchendHandler = (e) => {
                if (!isDragging) return;
                isDragging = false;
                document.removeEventListener('touchmove', touchmoveHandler);
                document.removeEventListener('touchend', globalTouchendHandler);
                document.removeEventListener('touchcancel', globalTouchendHandler);

                activeCard.style.transition = 'transform 0.3s ease-out, box-shadow 0.3s ease'; 
                activeCard.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.1)';

                const deltaX = e.changedTouches[0].clientX - startX;
                const swipeThreshold = 100;

                if (!isTap && Math.abs(deltaX) > swipeThreshold) { 
                    const direction = deltaX > 0 ? 'right' : 'left';
                    swipeCard(direction);
                } else if (isTap) { 
                    handleCardInteraction(e);
                } else {
                    activeCard.style.transform = initialTransform;
                }
            };

            const handleCardInteraction = (e) => {
                const audioZone = activeCard.querySelector('.audio-zone');
                // Check if the interaction originated from within the audio zone
                if (audioZone && audioZone.contains(e.target)) {
                    e.stopPropagation(); 
                    const currentCardDataIndex = parseInt(activeCard.dataset.cardDataIndex);
                    if (!isNaN(currentCardDataIndex) && flashcardsData[currentCardDataIndex]) {
                         if (flashcardsData[currentCardDataIndex].char) { 
                             // Using Text-to-Speech directly if no audio file exists
                             const charToSpeak = flashcardsData[currentCardDataIndex].char;
                             const utterance = new SpeechSynthesisUtterance(charToSpeak);
                             utterance.lang = 'zh-CN'; // Set language to Chinese
                             speechSynthesis.speak(utterance);
                         } else {
                             console.warn("No character available for audio playback.");
                         }
                    }
                    return; // Prevent card rotation if audio zone is clicked/tapped
                }
                
                // If it's a tap/click and not on the audio zone, rotate the card
                let currentStage = parseInt(activeCard.dataset.currentDisplayStage || 0);
                const nextStage = (currentStage + 1) % NUM_DISPLAY_STAGES; 
                updateDisplayStage(activeCard, nextStage);
            };
        }

        function removeEventListenersFromActiveCard() {
            if (currentCardListeners.mousedown) {
                const activeCard = flashcardStack.querySelector('.flashcard.active');
                if (activeCard) activeCard.removeEventListener('mousedown', currentCardListeners.mousedown);
                document.removeEventListener('mousemove', currentCardListeners.mousemoveHandler); 
                document.removeEventListener('mouseup', currentCardListeners.globalMouseupHandler);
            }
            if (currentCardListeners.touchstart) {
                const activeCard = flashcardStack.querySelector('.flashcard.active');
                if (activeCard) activeCard.removeEventListener('touchstart', currentCardListeners.touchstart);
                document.removeEventListener('touchmove', currentCardListeners.touchmoveHandler); 
                document.removeEventListener('touchend', currentCardListeners.globalTouchendHandler);
                document.removeEventListener('touchcancel', currentCardListeners.globalTouchendHandler);
            }
            currentCardListeners = {}; // Clear the stored listeners
        }
        
        // Removed `playAudio` as we're directly using Web Speech API for simplicity
        // If you still want local audio files, you'll need to re-implement `playAudio`
        // and ensure the `audios` directory exists with correctly named MP3s.

        // --- Score Overlay Logic ---
        function updateScoreDisplay() {
            const notMasteredColumn = document.querySelector('.score-column.not-mastered');
            const mediumColumn = document.querySelector('.score-column.medium');
            const masteredColumn = document.querySelector('.score-column.mastered');

            notMasteredColumn.innerHTML = '<h4>Ã€ Travailler (0-1)</h4>';
            mediumColumn.innerHTML = '<h4>Ã€ Revoir (2-3)</h4>';
            masteredColumn.innerHTML = '<h4>MaÃ®trisÃ© (4-5)</h4>';

            const sortedCards = flashcardsData
                .map((data, index) => ({ ...data, score: cardScores[index], originalIndex: index }))
                .sort((a, b) => a.score - b.score); 

            sortedCards.forEach(card => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('score-item');
                itemDiv.innerHTML = `
                    <span class="score-char">${card.char}</span>
                    <span class="score-details">${card.pinyin} (${card.score})</span>
                `;

                if (card.score <= 1) {
                    notMasteredColumn.appendChild(itemDiv);
                } else if (card.score <= 3) {
                    mediumColumn.appendChild(itemDiv);
                } else {
                    masteredColumn.appendChild(itemDiv);
                }
            });
        }

        function showScoreOverlay() {
            updateScoreDisplay();
            scoreOverlay.classList.add('visible');
        }

        function hideScoreOverlay() {
            scoreOverlay.classList.remove('visible');
        }

        // --- Home Indicator Bar Swipe Logic ---
        let touchStartY = 0;
        let isSwipingUp = false;
        const SWIPE_UP_THRESHOLD = -50; 

        homeIndicatorBar.addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
            isSwipingUp = true;
            e.preventDefault(); 
        }, { passive: false });

        homeIndicatorBar.addEventListener('touchmove', (e) => {
            if (!isSwipingUp) return;
            const currentY = e.touches[0].clientY;
            const deltaY = currentY - touchStartY;

            if (deltaY < SWIPE_UP_THRESHOLD) {
                showScoreOverlay();
                isSwipingUp = false; 
            }
        });

        homeIndicatorBar.addEventListener('touchend', () => {
            isSwipingUp = false;
        });

        homeIndicatorBar.addEventListener('touchcancel', () => {
            isSwipingUp = false;
        });
        
        homeIndicatorBar.addEventListener('click', showScoreOverlay); 


        // Close overlay on click outside modal or Escape key
        scoreOverlay.addEventListener('click', (e) => {
            if (e.target === scoreOverlay) { 
                hideScoreOverlay();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && scoreOverlay.classList.contains('visible')) {
                hideScoreOverlay();
            }
        });

        // --- Reset Button Logic ---
        resetButton.addEventListener('click', () => {
            if (confirm("ÃŠtes-vous sÃ»r de vouloir rÃ©initialiser tous les scores ? Cette action est irrÃ©versible.")) {
                for (let i = 0; i < cardScores.length; i++) {
                    cardScores[i] = INITIAL_SCORE;
                }
                updateScoreDisplay(); 
                showFeedback('Scores rÃ©initialisÃ©s !', 'incorrect'); 
            }
        });


        // Initial setup
        document.addEventListener('DOMContentLoaded', initializeCardStack);
    </script>
</body>
</html>