<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcards Mandarin</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column; /* Changed to column to stack elements vertically */
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
            overflow: hidden; /* Prevent scrollbars */
        }

        #flashcard-stack {
            width: 90vw;
            max-width: 500px;
            height: 60vh;
            max-height: 400px;
            position: relative; /* Container for stacked cards */
            display: flex; /* To center the cards within the stack */
            justify-content: center;
            align-items: center;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            margin-bottom: 20px; /* Space between cards and audio button */
        }

        .flashcard {
            width: 100%;
            height: 100%;
            position: absolute; /* Stack them on top of each other */
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            background-color: #fff;
            overflow: hidden;
            transition: transform 0.3s ease-out, box-shadow 0.3s ease, opacity 0.3s ease; 
            transform-origin: center center; /* Ensure rotation around center */
        }

        /* Styles for stacked effect */
        .flashcard:nth-child(2) { 
            transform: translateY(calc(10px + 1vw)) scale(0.95);
            opacity: 0.8;
            z-index: 0; 
        }
        .flashcard:nth-child(3) { 
            transform: translateY(calc(20px + 2vw)) scale(0.90);
            opacity: 0.6;
            z-index: -1; 
        }

        .flashcard.active {
            z-index: 1; 
            cursor: grab;
        }

        .flashcard-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out; 
            color: #000; 
        }

        .flashcard-content.active-display {
            opacity: 1;
            visibility: visible;
        }

        .flashcard-front h2 {
            font-size: clamp(4em, 10vw, 8em); /* Adjusted min size for better mobile visibility */
            font-weight: bold;
        }

        .flashcard-middle h2 { /* Pinyin */
            font-size: clamp(2em, 5vw, 3em); /* Adjusted min size */
        }

        .flashcard-back h2 { /* Translation */
            font-size: clamp(1.8em, 4vw, 2.5em); /* Adjusted min size */
        }
        
        .flashcard-example h2 { /* Example */
            font-size: clamp(1.2em, 3vw, 1.8em); /* Adjusted min size */
            padding: 10px;
            line-height: 1.5;
        }


        .flashcard-content h2 {
            margin: 0;
            line-height: 1.2;
            overflow-wrap: break-word;
            word-break: break-word;
            white-space: normal;
            padding: 10px;
            color: #000; 
        }

        /* Audio icon inside the card */
        .audio-icon {
            position: absolute;
            bottom: 15px; /* Adjust as needed */
            right: 15px; /* Adjust as needed */
            font-size: 2.5em; /* Adjust size of the speaker icon */
            cursor: pointer;
            color: #007bff; /* Color of the icon */
            transition: transform 0.1s ease-in-out, color 0.2s ease;
            z-index: 10; /* Ensure it's above content */
            background: none;
            border: none;
            padding: 0;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .audio-icon:hover {
            transform: scale(1.1);
            color: #0056b3;
        }

        .audio-icon:active {
            transform: scale(0.95);
        }

        #feedback {
            position: fixed;
            top: 20px;
            font-size: 1.5em;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            z-index: 100;
        }

        #feedback.show {
            opacity: 1;
        }

        #feedback.correct {
            color: #4CAF50;
            transform: translateY(0);
        }

        #feedback.incorrect {
            color: #F44336;
            transform: translateY(0);
        }

        /* --- Overlay Styles --- */
        #score-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: flex-end; /* Align modal to bottom */
            z-index: 200;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        #score-overlay.visible {
            visibility: visible;
            opacity: 1;
        }

        #score-modal {
            background-color: #fff;
            border-top-left-radius: 20px; /* Rounded top corners */
            border-top-right-radius: 20px;
            padding: 30px;
            width: 100%; /* Full width at bottom */
            max-width: 800px;
            height: 80vh; /* Takes 80% of screen height */
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden; 

            /* Initial state for slide-up animation */
            transform: translateY(100%); 
            transition: transform 0.3s ease-out;
        }

        #score-overlay.visible #score-modal {
            transform: translateY(0%); /* Slide up to visible position */
        }

        #score-modal h3 {
            text-align: center;
            margin-top: 0;
            color: #333;
            font-size: 1.8em;
            margin-bottom: 20px;
        }

        #score-columns {
            display: flex;
            flex-grow: 1; 
            gap: 20px;
            overflow-y: auto; 
        }

        .score-column {
            flex: 1;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            overflow-y: auto; 
        }

        .score-column.mastered {
            background-color: #e6ffe6; 
            border: 1px solid #4CAF50;
        }

        .score-column.medium {
            background-color: #fff8e1; 
            border: 1px solid #FFC107;
        }

        .score-column.not-mastered {
            background-color: #ffe6e6; 
            border: 1px solid #F44336;
        }

        .score-column h4 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2em;
            color: #333;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dotted #ccc;
            font-size: 1em;
        }

        .score-item:last-child {
            border-bottom: none;
        }

        .score-char {
            font-weight: bold;
            font-size: 1.1em;
        }

        .score-details {
            color: #666;
            font-size: 0.9em;
        }

        /* Home Indicator Bar */
        #home-indicator-bar {
            position: fixed;
            bottom: 8px; 
            left: 50%;
            transform: translateX(-50%);
            width: 130px; 
            height: 5px; 
            background-color: #000;
            border-radius: 100px; 
            z-index: 150; 
            cursor: pointer; 
        }

        #reset-button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            margin-top: 20px;
            align-self: center; 
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.2);
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        #reset-button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        #reset-button:active {
            background-color: #004085;
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div id="feedback"></div>
    <div id="flashcard-stack">
        </div>

    <audio id="audio-player"></audio>

    <div id="home-indicator-bar"></div>

    <div id="score-overlay">
        <div id="score-modal">
            <h3>Votre Progression</h3>
            <div id="score-columns">
                <div class="score-column not-mastered">
                    <h4>√Ä Travailler (0-1)</h4>
                </div>
                <div class="score-column medium">
                    <h4>√Ä Revoir (2-3)</h4>
                </div>
                <div class="score-column mastered">
                    <h4>Ma√Ætris√© (4-5)</h4>
                </div>
            </div>
            <button id="reset-button">R√©initialiser les scores</button>
        </div>
    </div>

    <script>
        const flashcardsData = [
            { char: "Êàë", pinyin: "w«í", translation: "je / moi", example: "ÊàëÊòØ‰∏Ä‰∏™Â≠¶Áîü (W«í sh√¨ yƒ´g√® xu√©shƒìng) - Je suis un √©tudiant." },
            { char: "‰Ω†", pinyin: "n«ê", translation: "tu / toi", example: "‰Ω†Â•ΩÂêóÔºü (N«ê h«éo ma?) - Comment vas-tu ?" },
            { char: "‰ªñ", pinyin: "tƒÅ", translation: "il / lui", example: "‰ªñÂæàÈ´ò (TƒÅ hƒõn gƒÅo) - Il est tr√®s grand." },
            { char: "Â•π", pinyin: "tƒÅ", translation: "elle", example: "Â•πÂæàÊºÇ‰∫Æ (TƒÅ hƒõn pi√†oliang) - Elle est tr√®s belle." },
            { char: "Êàë‰ª¨", pinyin: "w«ímen", translation: "nous", example: "Êàë‰ª¨ÂéªÂêÉÈ•≠ (W«ímen q√π chƒ´f√†n) - Nous allons manger." },
            { char: "‰Ω†‰ª¨", pinyin: "n«êmen", translation: "vous", example: "‰Ω†‰ª¨Â•ΩÔºÅ (N«êmen h«éo!) - Bonjour √† vous !" },
            { char: "‰ªñ‰ª¨", pinyin: "tƒÅmen", translation: "ils / eux", example: "‰ªñ‰ª¨ÊòØ‰∏≠ÂõΩ‰∫∫ (TƒÅmen sh√¨ zh≈çnggu√≥ r√©n) - Ce sont des Chinois." },
            { char: "Â•π‰ª¨", pinyin: "tƒÅmen", translation: "elles", example: "Â•π‰ª¨ÊòØÊúãÂèã (TƒÅmen sh√¨ p√©ngy«íu) - Elles sont amies." },
            { char: "Âßì", pinyin: "x√¨ng", translation: "s'appeler (nom de famille)", example: "‰Ω†Âßì‰ªÄ‰πàÔºü (N«ê x√¨ng sh√©nme?) - Comment t'appelles-tu (nom de famille) ?" },
            { char: "Âè´", pinyin: "ji√†o", translation: "s'appeler (pr√©nom)", example: "ÊàëÂè´ÁéãÊòé (W«í ji√†o W√°ng M√≠ng) - Je m'appelle Wang Ming." },
            { char: "Â≠¶", pinyin: "xu√©", translation: "√©tudier", example: "ÊàëÂ≠¶Ê±âËØ≠ (W«í xu√© h√†ny«î) - J'√©tudie le chinois." },
            { char: "ÊòØ", pinyin: "sh√¨", translation: "√™tre", example: "ÊàëÊòØÊ≥ïÂõΩ‰∫∫ (W«í sh√¨ F√†gu√≥ r√©n) - Je suis fran√ßais." },
            { char: "Áîü", pinyin: "shƒìng", translation: "na√Ætre / √©l√®ve", example: "ÊàëÁöÑÁîüÊó•ÊòØ‰ªäÂ§© (W«í de shƒìngr√¨ sh√¨ jƒ´n tiƒÅn) - Mon anniversaire est aujourd'hui." },
            { char: "Êúâ", pinyin: "y«íu", translation: "avoir", example: "ÊàëÊúâ‰∏Ä‰∏™ËãπÊûú (W«í y«íu yƒ´g√® p√≠nggu«í) - J'ai une pomme." },
            { char: "ËØ¥", pinyin: "shu≈ç", translation: "dire / parler", example: "‰Ω†‰ºöËØ¥Ê±âËØ≠ÂêóÔºü (N«ê hu√¨ shu≈ç h√†ny«î ma?) - Sais-tu parler chinois ?" },
            { char: "Âú®", pinyin: "z√†i", translation: "√™tre (quelque part)", example: "ÊàëÂú®ÂÆ∂ (W«í z√†i jiƒÅ) - Je suis √† la maison." },
            { char: "Âéª", pinyin: "q√π", translation: "aller", example: "Êàë‰ª¨ÂéªÂ≠¶Ê†° (W«ímen q√π xu√©xi√†o) - Nous allons √† l'√©cole." },
            { char: "Êù•", pinyin: "l√°i", translation: "venir", example: "ËØ∑‰Ω†Êù•ÊàëÂÆ∂ (Q«êng n«ê l√°i w«í jiƒÅ) - S'il te pla√Æt, viens chez moi." },
            { char: "Âõû", pinyin: "hu√≠", translation: "revenir", example: "ÊàëÂõûÂÆ∂‰∫Ü (W«í hu√≠ jiƒÅ le) - Je suis rentr√© √† la maison." },
            { char: "‰Ωè", pinyin: "zh√π", translation: "habiter / demeurer", example: "‰Ω†‰ΩèÂú®Âì™ÈáåÔºü (N«ê zh√π z√†i n«él«ê?) - O√π habites-tu ?" },
            { char: "Â∑•‰Ωú", pinyin: "g≈çngzu√≤", translation: "travailler", example: "ÊàëÂú®Âåó‰∫¨Â∑•‰Ωú (W«í z√†i Bƒõijƒ´ng g≈çngzu√≤) - Je travaille √† P√©kin." },
            { char: "‰ºëÊÅØ", pinyin: "xi≈´xi", translation: "se reposer", example: "ÊàëÈúÄË¶Å‰ºëÊÅØ (W«í x≈´y√†o xi≈´xi) - J'ai besoin de repos." },
            { char: "Êâæ", pinyin: "zh«éo", translation: "chercher", example: "ÊàëÂú®ÊâæÊàëÁöÑ‰π¶ (W«í z√†i zh«éo w«í de sh≈´) - Je cherche mon livre." },
            { char: "ÈóÆ", pinyin: "w√®n", translation: "demander", example: "ÊàëÈóÆ‰∏Ä‰∏™ÈóÆÈ¢ò (W«í w√®n yƒ´g√® w√®nt√≠) - Je pose une question." },
            { char: "Âñù", pinyin: "hƒì", translation: "boire", example: "ÊàëÊÉ≥ÂñùËå∂ (W«í xi«éng hƒì ch√°) - J'aimerais boire du th√©." },
            { char: "ÊÉ≥", pinyin: "xi√¢ng", translation: "vouloir", example: "ÊàëÊÉ≥Âéª‰∏≠ÂõΩ (W«í xi«éng q√π Zh≈çnggu√≥) - J'aimerais aller en Chine." },
            { char: "Áü•ÈÅì", pinyin: "zhƒ´d√†o", translation: "savoir", example: "Êàë‰∏çÁü•ÈÅì (W«í b√π zhƒ´d√†o) - Je ne sais pas." },
            { char: "Áúã", pinyin: "k√†n", translation: "voir / observer", example: "‰Ω†Áúã‰ªÄ‰πàÔºü (N«ê k√†n sh√©nme?) - Que regardes-tu ?" },
            { char: "‰∏ç", pinyin: "b√π", translation: "n√©gation", example: "Êàë‰∏çÂ•Ω (W«í b√π h«éo) - Je ne vais pas bien." },
            { char: "Ê≤°", pinyin: "m√©i", translation: "n√©gation (pass√©)", example: "ÊàëÊ≤°ÂéªËøá (W«í m√©i q√πgu√≤) - Je n'y suis jamais all√©." },
            { char: "Âë¢", pinyin: "ne", translation: "particule interrogative", example: "‰Ω†Âë¢Ôºü (N«ê ne?) - Et toi ?" },
            { char: "Âêó", pinyin: "ma", translation: "particule interrogative", example: "‰Ω†ÊòØÂ≠¶ÁîüÂêóÔºü (N«ê sh√¨ xu√©shƒìng ma?) - Es-tu √©tudiant ?" },
            { char: "Âêß", pinyin: "ba", translation: "particule de suggestion", example: "Êàë‰ª¨Ëµ∞Âêß (W«ímen z«íu ba) - Allons-y." },
            { char: "‰ªÄ‰πà", pinyin: "sh√©nme", translation: "quoi / que", example: "ËøôÊòØ‰ªÄ‰πàÔºü (Zh√® sh√¨ sh√©nme?) - Qu'est-ce que c'est ?" },
            { char: "Âì™", pinyin: "n«é", translation: "quel / lequel", example: "‰Ω†ÊòØÂì™ÂõΩ‰∫∫Ôºü (N«ê sh√¨ n«é gu√≥ r√©n?) - De quel pays es-tu ?" },
            { char: "Âá†", pinyin: "j«ê", translation: "combien (petit nombre) / quelques", example: "‰Ω†ÊúâÂá†Êú¨‰π¶Ôºü (N«ê y«íu j«ê ben sh≈´?) - Tu as combien de livres ?" },
            { char: "Ë∞Å", pinyin: "sh√©i", translation: "qui ?", example: "‰ªñÊòØË∞ÅÔºü (TƒÅ sh√¨ sh√©i?) - Qui est-il ?" },
            { char: "‰πü", pinyin: "yƒõ", translation: "aussi", example: "Êàë‰πüÂéª (W«í yƒõ q√π) - J'y vais aussi." },
            { char: "Ëøô", pinyin: "zh√®", translation: "ce / cette", example: "ËøôÊòØÊàëÁöÑ‰π¶ (Zh√® sh√¨ w«í de sh≈´) - C'est mon livre." },
            { char: "ÁöÑ", pinyin: "de", translation: "particule possessive", example: "ÊàëÁöÑÁ¨î (W«í de b«ê) - Mon stylo." },
            { char: "‰∏™", pinyin: "g√®", translation: "classificateur g√©n√©ral", example: "‰∏Ä‰∏™‰∫∫ (Yƒ´g√® r√©n) - Une personne." },
            { char: "‰∏§", pinyin: "li«éng", translation: "deux (quantit√©)", example: "‰∏§‰∏™‰∫∫ (Li«éng g√® r√©n) - Deux personnes." },
            { char: "Êú¨", pinyin: "bƒõn", translation: "classificateur pour les livres / racine / origine / fondamentale", example: "‰∏ÄÊú¨‰π¶ (Yƒ´ bƒõn sh≈´) - Un livre." },
            { char: "Âè£", pinyin: "k«íu", translation: "classificateur membres famille / bouche", example: "‰∏âÂè£‰∫∫ (SƒÅn k«íu r√©n) - Trois membres de la famille." },
            { char: "‰∏Ä", pinyin: "yƒ´", translation: "un", example: "‰∏Ä‰∏™ËãπÊûú (Yƒ´g√® p√≠nggu«í) - Une pomme." },
            { char: "‰∫å", pinyin: "√®r", translation: "deux", example: "‰∫åÊúà (√àryu√®) - F√©vrier." },
            { char: "‰∏â", pinyin: "sƒÅn", translation: "trois", example: "‰∏â‰∏™Â≠¶Áîü (SƒÅn g√® xu√©shƒìng) - Trois √©tudiants." },
            { char: "Âõõ", pinyin: "s√¨", translation: "quatre", example: "ÂõõÁÇπ (S√¨ di«én) - Quatre heures." },
            { char: "‰∫î", pinyin: "w«î", translation: "cinq", example: "‰∫îÊú¨‰π¶ (W«î bƒõn sh≈´) - Cinq livres." },
            { char: "ÂÖ≠", pinyin: "li√π", translation: "six", example: "ÂÖ≠Â§© (Li√π tiƒÅn) - Six jours." },
            { char: "‰∏É", pinyin: "qƒ´", translation: "sept", example: "‰∏ÉÊúà (Qƒ´yu√®) - Juillet." },
            { char: "ÂÖ´", pinyin: "bƒÅ", translation: "huit", example: "ÂÖ´Â≤Å (BƒÅ su√¨) - Huit ans." },
            { char: "‰πù", pinyin: "ji«î", translation: "neuf", example: "‰πùÁÇπÈíü (Ji«î di«én zh≈çng) - Neuf heures." },
            { char: "ÂçÅ", pinyin: "sh√≠", translation: "dix", example: "ÂçÅ‰∏™‰∫∫ (Sh√≠ g√® r√©n) - Dix personnes." },
            { char: "Â§öÂ∞ë", pinyin: "du≈çsh«éo", translation: "combien ?", example: "‰Ω†ÊúâÂ§öÂ∞ëÈí±Ôºü (N«ê y«íu du≈çsh«éo qi√°n?) - Combien d'argent as-tu ?" },
            { char: "Â§öÂ§ß", pinyin: "du≈ç d√†", translation: "quel √¢ge ?", example: "‰Ω†Â§öÂ§ß‰∫ÜÔºü (N«ê du≈ç d√† le?) - Quel √¢ge as-tu ?" },
            { char: "Â≤Å", pinyin: "su√¨", translation: "√¢ge", example: "ÊàëÂçÅÂÖ´Â≤Å (W«í sh√≠bƒÅ su√¨) - J'ai dix-huit ans." },
            { char: "Âá†Â≤Å", pinyin: "j«ê su√¨", translation: "Pour les enfants (moins de 10 ans)", example: "‰Ω†Âá†Â≤Å‰∫ÜÔºü (N«ê j«ê su√¨ le?) - Quel √¢ge as-tu (enfant) ?" },
            { char: "ÊÇ®Â§öÂ§ßÂπ¥Á∫™", pinyin: "N√≠n du≈ç d√† ni√°nj√¨ ?", translation: "Pour √™tre poli avec des personnes √¢g√©es", example: "Vous avez quel √¢ge (poli) ?" },
            { char: "Âú®", pinyin: "z√†i", translation: "√™tre (quelque part)", example: "ÊàëÂú®ÂÆ∂ (W«í z√†i jiƒÅ) - Je suis √† la maison." },
            { char: "Âì™ÂÑø", pinyin: "n«ér", translation: "o√π", example: "‰Ω†ÂéªÂì™ÂÑøÔºü (N«ê q√π n«ér?) - O√π vas-tu ?" },
            { char: "Âπ¥", pinyin: "ni√°n", translation: "ann√©e", example: "‰ªäÂπ¥ÊòØ‰∫åÈõ∂‰∫å‰∫îÂπ¥ (Jƒ´nni√°n sh√¨ √®r l√≠ng √®r w«î ni√°n) - Cette ann√©e est 2025." },
            { char: "ÊòüÊúü", pinyin: "xƒ´ngqƒ´", translation: "semaine", example: "‰∏Ä‰∏™ÊòüÊúü (Yƒ´g√® xƒ´ngqƒ´) - Une semaine." },
            { char: "Êó•", pinyin: "r√¨", translation: "jour", example: "‰ªäÂ§©ÊòØÊòüÊúüÊó• (Jƒ´ntiƒÅn sh√¨ xƒ´ngqƒ´r√¨) - Aujourd'hui est dimanche." },
            { char: "Âè∑", pinyin: "h√†o", translation: "jour/date (oral)", example: "ÂçÅÊúà‰∏ÄÂè∑ (Sh√≠ yu√® yƒ´ h√†o) - Le 1er octobre." },
            { char: "Êúà", pinyin: "yu√®", translation: "mois", example: "‰∏âÊúà (SƒÅnyu√®) - Mars." },
            { char: "ÊòüÊúüÊó•", pinyin: "xƒ´ngqƒ´r√¨", translation: "dimanche", example: "ÊòüÊúüÊó•‰ºëÊÅØ (Xƒ´ngqƒ´r√¨ xi≈´xi) - Se reposer le dimanche." },
            { char: "ÁîüÊó•", pinyin: "shƒìngr√¨", translation: "anniversaire", example: "Á•ù‰Ω†ÁîüÊó•Âø´‰πê (Zh√π n«ê shƒìngr√¨ ku√†il√®) - Joyeux anniversaire." },
            { char: "Âá†", pinyin: "j«ê", translation: "combien (petit nombre / heure / √¢ge)", example: "Áé∞Âú®Âá†ÁÇπ‰∫ÜÔºü (Xi√†nz√†i j«ê di«én le?) - Quelle heure est-il maintenant ?" },
            { char: "‰ªäÂ§©", pinyin: "jƒ´ntiƒÅn", translation: "aujourd'hui", example: "‰ªäÂ§©Â§©Ê∞îÂæàÂ•Ω (Jƒ´ntiƒÅn tiƒÅnq√¨ hƒõn h«éo) - Il fait beau aujourd'hui." },
            { char: "ÊòéÂ§©", pinyin: "m√≠ngtiƒÅn", translation: "demain", example: "ÊòéÂ§©ËßÅ (M√≠ngtiƒÅn ji√†n) - √Ä demain." },
            { char: "Êò®Â§©", pinyin: "zu√≥tiƒÅnhier", translation: "hier", example: "Êò®Â§©ÊàëÊ≤°Âéª (Zu√≥tiƒÅn w«í m√©i q√π) - Je n'y suis jamais all√© hier." },
            { char: "‰∏äÂçà", pinyin: "sh√†ngw«î", translation: "matin", example: "‰∏äÂçàÂ•Ω (Sh√†ngw«î h«éo) - Bonjour (matin)." },
            { char: "‰∏≠Âçà", pinyin: "zh≈çngw«î", translation: "midi", example: "‰∏≠ÂçàÂêÉÈ•≠ (Zh≈çngw«î chƒ´f√†n) - Manger √† midi." },
            { char: "‰∏ãÂçà", pinyin: "xi√†w«î", translation: "apr√®s-midi", example: "‰∏ãÂçàÂéªÂÖ¨Âõ≠ (Xi√†w«î q√π g≈çngyu√°n) - Aller au parc l'apr√®s-midi." },
            { char: "Êó©‰∏ä", pinyin: "z«éoshang", translation: "matin (tr√®s t√¥t)", example: "Êó©‰∏äÂ•Ω (Z«éoshang h«éo) - Bonjour (tr√®s t√¥t le matin)." },
            { char: "Êôö‰∏ä", pinyin: "w«énshang", translation: "soir", example: "Êôö‰∏äÂ•Ω (W«énshang h«éo) - Bonsoir." },
            { char: "‰ªäÂπ¥", pinyin: "jƒ´nni√°n", translation: "cette ann√©e", example: "Êàë‰ªäÂπ¥‰∏âÂçÅÂ≤Å (W«í jƒ´nni√°n sƒÅnsh√≠ su√¨) - J'ai trente ans cette ann√©e." },
            { char: "ÊòéÂπ¥", pinyin: "m√≠ngni√°n", translation: "l'ann√©e prochaine", example: "ÊòéÂπ¥ÂÜçËßÅ (M√≠ngni√°n z√†iji√†n) - √Ä l'ann√©e prochaine." },
            { char: "ÂéªÂπ¥", pinyin: "q√πni√°n", translation: "l'ann√©e derni√®re", example: "ÂéªÂπ¥ÊàëÂéª‰∫ÜÊó•Êú¨ (Q√πni√°n w«í q√π le R√¨bƒõn) - L'ann√©e derni√®re, je suis all√© au Japon." },
            { char: "Èíü", pinyin: "zh≈çng", translation: "horloge / utilis√© pour l'heure pr√©cise", example: "‰∏âÁÇπÈíü (SƒÅn di«én zh≈çng) - Trois heures pr√©cises." },
            { char: "ÁÇπ", pinyin: "di«én", translation: "point / unit√© de compte pour l'heure", example: "Áé∞Âú®‰∫îÁÇπ (Xi√†nz√†i w«î di«én) - Il est cinq heures." },
            { char: "ÂàÜ", pinyin: "fƒìn", translation: "minute", example: "ÂçÅÂàÜÈíü (Sh√≠ fƒìnzh≈çng) - Dix minutes." },
            { char: "Âàª", pinyin: "k√®", translation: "quart d'heure", example: "‰∏§ÁÇπ‰∏ÄÂàª (Li«éng di«én yƒ´ k√®) - Deux heures et quart." },
            { char: "Âçä", pinyin: "b√†n", translation: "demi (30 minutes)", example: "‰∏âÁÇπÂçä (SƒÅn di«én b√†n) - Trois heures et demie." },
            { char: "‰∏âÁÇπÈíü", pinyin: "sƒÅn di«én zh≈çng", translation: "3 heures", example: "ÁÅ´ËΩ¶‰∏âÁÇπÈíüÂºÄ (Hu«íchƒì sƒÅn di«én zh≈çng kƒÅi) - Le train part √† trois heures." },
            { char: "‰∏âÁÇπ‰∫îÂàÜ", pinyin: "sƒÅn di«én w«î fƒìn", translation: "3h05", example: "‰ºöËÆÆ‰∏âÁÇπ‰∫îÂàÜÂºÄÂßã (Hu√¨y√¨ sƒÅn di«én w«î fƒìn kƒÅish«ê) - La r√©union commence √† 3h05." },
            { char: "ÂÖ≠ÁÇπ‰∏ÄÂàª", pinyin: "li√π di«én yƒ´ k√®", translation: "6h15", example: "Nous six heures et un quart se rencontrent." },
            { char: "ÂÖ≠ÁÇπÂçä", pinyin: "li√π di«én b√†n", translation: "6h30", example: "Elle six heures et demie rentre √† la maison." },
            { char: "‰∏ÉÁÇπÂ∑Æ‰∏ÄÂàª", pinyin: "qƒ´ di«én ch√† yƒ´ k√®", translation: "6h45", example: "Maintenant, il est sept heures moins le quart." },
            { char: "ÂÖ≠ÁÇπ‰∏âÂàª", pinyin: "li√π di«én sƒÅn k√®", translation: "6h45 (alternative)", example: "Il arrive √† six heures trois quarts." },
            { char: "Â•Ω", pinyin: "h«éo", translation: "bien", example: "Je vais tr√®s bien." },
            { char: "Â§ß", pinyin: "d√†", translation: "grand", example: "Cette maison est tr√®s grande." },
            { char: "Â∞è", pinyin: "xi«éo", translation: "petit", example: "Mon chien est petit." },
            { char: "ËÄÅ", pinyin: "l«éo", translation: "vieux", example: "Il est un vieil ami." },
            { char: "Ëøá", pinyin: "gu√≤", translation: "(pass√© d'exp√©rience)", example: "Je suis all√© en Chine (exp√©rience)." },
            { char: "ÂêçÂ≠ó", pinyin: "m√≠ngzi", translation: "pr√©nom", example: "Quel est ton pr√©nom ?" },
            { char: "Âßì", pinyin: "x√¨ng", translation: "nom de famille", example: "Son nom de famille est Li." },
            { char: "‰∫∫", pinyin: "r√©n", translation: "personne", example: "Personne chinoise / Chinois." },
            { char: "Ëøô‰∏™‰∫∫", pinyin: "zh√® ge r√©n", translation: "cette personne-ci", example: "Qui est cette personne ?" },
            { char: "ÈÇ£‰∏™‰∫∫", pinyin: "n√† ge r√©n", translation: "cette personne-l√†", example: "Cette personne-l√† est mon professeur." },
            { char: "ÈÉΩ", pinyin: "d≈çu", translation: "tous / tout", example: "Nous sommes tous √©tudiants." },
            { char: "ÊúãÂèã", pinyin: "p√©ngy«íu", translation: "ami", example: "C'est mon bon ami." },
            { char: "Áî∑ÊúãÂèã", pinyin: "n√°n p√©ngy«íu", translation: "petit ami", example: "Elle a un petit ami." },
            { char: "Â•≥ÊúãÂèã", pinyin: "n«ö p√©ngy«íu", translation: "petite amie", example: "Il a une petite amie." },
            { char: "ÂßêÂßê", pinyin: "jiƒõjie", translation: "grande s≈ìur", example: "J'ai une grande s≈ìur." },
            { char: "Â¶πÂ¶π", pinyin: "m√®imei", translation: "petite s≈ìur", example: "Ma petite s≈ìur est tr√®s mignonne." },
            { char: "Âì•Âì•", pinyin: "gƒìge", translation: "grand fr√®re", example: "Je n'ai pas de grand fr√®re." },
            { char: "ÂºüÂºü", pinyin: "d√¨di", translation: "petit fr√®re", example: "C'est mon petit fr√®re." },
            { char: "Áà∏Áà∏", pinyin: "b√†ba", translation: "papa", example: "J'aime papa et maman." },
            { char: "Â¶àÂ¶à", pinyin: "mƒÅmƒÅ", translation: "maman", example: "Ma maman est √† la maison." },
            { char: "Â≠©Â≠ê", pinyin: "h√°izi", translation: "enfant", example: "Elle a deux enfants." },
            { char: "Áà∂ÊØç", pinyin: "f√πm«î", translation: "parents", example: "Mes parents sont chinois." },
            { char: "Â≠¶Áîü", pinyin: "xu√©shƒìng", translation: "√©tudiant", example: "Il est un √©tudiant." },
            { char: "Â§ßÂ≠¶Áîü", pinyin: "d√†xu√©shƒìng", translation: "√©tudiant (sup√©rieur)", example: "Il est un √©tudiant universitaire." },
            { char: "‰∏≠Â≠¶Áîü", pinyin: "zh≈çngxu√©shƒìng", translation: "√©l√®ve du secondaire", example: "Mon cousin est √©l√®ve au coll√®ge/lyc√©e." },
            { char: "Â∞èÂ≠¶Áîü", pinyin: "xi«éoxu√©shƒìng", translation: "√©l√®ve du primaire", example: "Elle est une √©l√®ve de primaire." },
            { char: "ÂçöÂ£´", pinyin: "b√≥sh√¨", translation: "docteur (titre acad√©mique)", example: "Il est docteur (PhD)." },
            { char: "Ê±âËØ≠", pinyin: "h√†ny«î", translation: "langue chinoise", example: "J'apprends le chinois." },
            { char: "Êó•ËØ≠", pinyin: "r√¨y«î", translation: "langue japonaise", example: "Parles-tu japonais ?" },
            { char: "Ê≥ïËØ≠", pinyin: "f«éy«î", translation: "langue fran√ßaise", example: "Je viens de France, donc je parle fran√ßais." },
            { char: "Ëã±ËØ≠", pinyin: "yƒ´ngy«î", translation: "langue anglaise", example: "Son anglais est tr√®s bon." },
            { char: "Âæ∑ËØ≠", pinyin: "d√©y«î", translation: "langue allemande", example: "Je ne parle pas allemand." },
            { char: "Êñá", pinyin: "w√©n", translation: "√©criture / langue", example: "Langue chinoise (√©crite)." },
            { char: "ÂéÜÂè≤", pinyin: "l√¨sh«ê", translation: "histoire", example: "J'aime l'histoire." },
            { char: "Ëâ∫ÊúØ", pinyin: "y√¨sh√π", translation: "art", example: "Elle √©tudie l'art." },
            { char: "ÊñáÂ≠¶", pinyin: "w√©nxu√©", translation: "litt√©rature", example: "Il est tr√®s int√©ress√© par la litt√©rature." },
            { char: "Êï∞Â≠¶", pinyin: "sh√πxu√©", translation: "math√©matiques", example: "Les math√©matiques sont difficiles." },
            { char: "‰∏≠ÂõΩ", pinyin: "zh≈çnggu√≥", translation: "Chine", example: "J'aime la Chine." },
            { char: "Âåó‰∫¨", pinyin: "bƒõijƒ´ng", translation: "P√©kin", example: "Je suis all√© √† P√©kin." },
            { char: "Ê≥ïÂõΩ", pinyin: "f«égu√≥", translation: "France", example: "Je suis fran√ßais." },
            { char: "ËΩ¶", pinyin: "chƒì", translation: "v√©hicule", example: "Cette voiture est tr√®s belle." },
            { char: "Ê±ΩËΩ¶", pinyin: "q√¨chƒì", translation: "voiture", example: "Il a une voiture." },
            { char: "Ëá™Ë°åËΩ¶", pinyin: "z√¨x√≠ngchƒì", translation: "v√©lo", example: "Je vais au travail √† v√©lo." },
            { char: "ÂõΩ", pinyin: "gu√≥", translation: "pays", example: "Quel est ton pays ?" },
            { char: "‰∫∫Âè£", pinyin: "r√©nk«íu", translation: "population", example: "La population chinoise est tr√®s nombreuse." },
            { char: "ÂåóÊñπ‰∫∫", pinyin: "bƒõifƒÅngr√©n", translation: "gens du nord", example: "Je suis du nord (de la Chine)." },
            { char: "ÂçóÊñπ‰∫∫", pinyin: "n√°nfƒÅngr√©n", translation: "gens du sud", example: "Il est du sud (de la Chine)." },
            { char: "‰∏≠", pinyin: "zh≈çng", translation: "au centre / milieu", example: "Au milieu." },
            { char: "Âåó", pinyin: "bƒõi", translation: "nord", example: "P√©kin est au nord." },
            { char: "Âçó", pinyin: "n√°n", translation: "sud", example: "Le sud est tr√®s chaud." },
            { char: "‰∏ú", pinyin: "d≈çng", translation: "est", example: "L'Est." },
            { char: "Ë•ø", pinyin: "xƒ´", translation: "ouest", example: "Culture occidentale." },
            { char: "Ëå∂", pinyin: "ch√°", translation: "th√©", example: "S'il vous pla√Æt, buvez du th√©." },
            { char: "ÊòØ", pinyin: "sh√¨", translation: "Oui", example: "Oui, c'est √ßa." },
            { char: "‰∏ç", pinyin: "b√π", translation: "non", example: "Non, ce n'est pas juste." },
            { char: "Á∫¢", pinyin: "h√≥ng", translation: "rouge", example: "Couleur rouge." },
            { char: "Áªø", pinyin: "l√º", translation: "Vert", example: "Couleur verte." },
            { char: "Â•∂", pinyin: "n«éi", translation: "lait", example: "Lait de vache." }
        ];

        let cardScores = new Array(flashcardsData.length).fill(2); 
        const INITIAL_SCORE = 2; 
        const SCORE_MAX = 5;
        const SCORE_MIN = 0;
        const NUM_CARDS_IN_STACK = 3; 
        const NUM_DISPLAY_STAGES = 4; // Char, Pinyin, Translation, Example

        const flashcardStack = document.getElementById('flashcard-stack');
        const audioPlayer = document.getElementById('audio-player'); 
        const feedbackDisplay = document.getElementById('feedback');
        const scoreOverlay = document.getElementById('score-overlay');
        const homeIndicatorBar = document.getElementById('home-indicator-bar');
        const resetButton = document.getElementById('reset-button');
        
        let cardDataQueue = []; 

        function showFeedback(message, type) {
            feedbackDisplay.textContent = message;
            feedbackDisplay.className = 'show ' + type;
            setTimeout(() => {
                feedbackDisplay.className = '';
            }, 1000);
        }

        function getWeightedRandomCardIndex() {
            let weightedIndexes = [];
            for (let i = 0; i < flashcardsData.length; i++) {
                const weight = SCORE_MAX - cardScores[i] + 1;
                for (let j = 0; j < weight; j++) {
                    weightedIndexes.push(i);
                }
            }
            if (weightedIndexes.length === 0 && flashcardsData.length > 0) {
                 return Math.floor(Math.random() * flashcardsData.length);
            } else if (flashcardsData.length === 0) {
                return -1;
            }
            const randomIndex = Math.floor(Math.random() * weightedIndexes.length);
            return weightedIndexes[randomIndex];
        }

        function fillCardQueue() {
            while (cardDataQueue.length < NUM_CARDS_IN_STACK + 1) { 
                let newIndex = getWeightedRandomCardIndex();
                if (newIndex !== -1) {
                    const displayedCardDataIndices = Array.from(flashcardStack.children).map(cardEl => parseInt(cardEl.dataset.cardDataIndex));
                    // Check if the new index is already in the current stack or in the queue to avoid duplicates right away
                    if (!displayedCardDataIndices.includes(newIndex) && !cardDataQueue.includes(newIndex)) {
                        cardDataQueue.push(newIndex);
                    } else {
                        // If it's a duplicate, try to find another unique card
                        let foundUnique = false;
                        for(let i = 0; i < flashcardsData.length; i++) {
                            if (!displayedCardDataIndices.includes(i) && !cardDataQueue.includes(i)) {
                                newIndex = i; // Found a unique index
                                cardDataQueue.push(newIndex);
                                foundUnique = true;
                                break;
                            }
                        }
                        if (!foundUnique && flashcardsData.length > 0) { // If no unique card left, allow duplicates if needed to fill stack
                            cardDataQueue.push(newIndex); 
                        } else if (flashcardsData.length === 0) {
                             console.warn("No cards available in flashcardsData.");
                             break;
                        }
                    }
                } else {
                    console.warn("No more cards to add to queue.");
                    break;
                }
            }
        }


        function createFlashcardElement(cardDataIndex, domIndex) {
            const flashcardDiv = document.createElement('div');
            flashcardDiv.classList.add('flashcard');
            flashcardDiv.id = `flashcard-${domIndex}`;
            flashcardDiv.dataset.cardDataIndex = cardDataIndex; 

            const cardContents = ['front', 'middle', 'back', 'example'];
            const cardValues = [
                flashcardsData[cardDataIndex].char,
                flashcardsData[cardDataIndex].pinyin,
                flashcardsData[cardDataIndex].actualTranslation || flashcardsData[cardDataIndex].translation, 
                flashcardsData[cardDataIndex].example 
            ];

            cardContents.forEach((type, i) => {
                const contentDiv = document.createElement('div');
                contentDiv.classList.add('flashcard-content', `flashcard-${type}`);
                contentDiv.id = `card-${domIndex}-${type}`;
                const h2 = document.createElement('h2');
                h2.textContent = cardValues[i];
                contentDiv.appendChild(h2);
                flashcardDiv.appendChild(contentDiv);
            });

            // Add audio icon directly to the card
            const audioIcon = document.createElement('button');
            audioIcon.classList.add('audio-icon');
            audioIcon.innerHTML = 'üîä'; 
            audioIcon.title = '√âcouter la prononciation';
            audioIcon.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent card tap/swipe when clicking the icon
                playAudioForCard(cardDataIndex);
            });
            audioIcon.addEventListener('touchend', (e) => {
                e.stopPropagation(); // Prevent card tap/swipe when touching the icon
                e.preventDefault(); // Prevent default touch behavior
                playAudioForCard(cardDataIndex);
            });
            flashcardDiv.appendChild(audioIcon);

            return flashcardDiv;
        }

        function initializeCardStack() {
            fillCardQueue();
            flashcardStack.innerHTML = ''; 
            for (let i = 0; i < NUM_CARDS_IN_STACK; i++) {
                if (cardDataQueue.length > i) {
                    const cardElement = createFlashcardElement(cardDataQueue[i], i);
                    flashcardStack.appendChild(cardElement);
                }
            }
            if (flashcardStack.children.length > 0) {
                flashcardStack.children[0].classList.add('active');
                updateDisplayStage(flashcardStack.children[0], 0); 
            }
            applyStackStyles(); 
            addEventListenersToActiveCard();
        }

        function swipeCard(direction, onComplete) {
            const activeCard = flashcardStack.querySelector('.flashcard.active');
            if (!activeCard) {
                if (onComplete) onComplete(); 
                return;
            }

            removeEventListenersFromActiveCard(); 

            const swipedCardDataIndex = parseInt(activeCard.dataset.cardDataIndex);

            activeCard.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out'; 
            let rotation = direction === 'right' ? 'rotate(10deg)' : 'rotate(-10deg)';
            let translateX = direction === 'right' ? '150%' : '-150%';
            activeCard.style.transform = `translateX(${translateX}) translateY(0) ${rotation}`;
            activeCard.style.opacity = '0';
            activeCard.classList.remove('active');

            if (swipedCardDataIndex !== undefined && swipedCardDataIndex !== -1) {
                 if (direction === 'right') {
                    if (cardScores[swipedCardDataIndex] < SCORE_MAX) cardScores[swipedCardDataIndex]++;
                    showFeedback('Bravo !', 'correct');
                 } else { 
                    if (cardScores[swipedCardDataIndex] > SCORE_MIN) cardScores[swipedCardDataIndex]--;
                    showFeedback('√Ä revoir !', 'incorrect');
                 }
            }
            
            activeCard.addEventListener('transitionend', () => {
                activeCard.remove(); 

                cardDataQueue.shift(); 
                fillCardQueue(); 

                if (cardDataQueue.length > NUM_CARDS_IN_STACK - 1) { 
                    const newCardDataIndex = cardDataQueue[NUM_CARDS_IN_STACK - 1]; 
                    const newCardElement = createFlashcardElement(newCardDataIndex, flashcardStack.children.length); 
                    flashcardStack.appendChild(newCardElement);
                } else if (flashcardsData.length > 0 && cardDataQueue.length === 0) {
                     fillCardQueue(); 
                     if (cardDataQueue.length > 0) {
                        const newCardDataIndex = cardDataQueue[0]; 
                        const newCardElement = createFlashcardElement(newCardDataIndex, flashcardStack.children.length);
                        flashcardStack.appendChild(newCardElement);
                     }
                }


                applyStackStyles(); 
                if (onComplete) onComplete();

            }, { once: true });
        }

        function applyStackStyles() {
            const cards = flashcardStack.children;
            for (let i = 0; i < cards.length; i++) {
                cards[i].style.transition = 'transform 0.2s ease-out, opacity 0.2s ease-out, box-shadow 0.3s ease'; 
                cards[i].style.opacity = '1'; 

                cards[i].style.transform = ''; 
                cards[i].classList.remove('active'); 

                if (i === 0) {
                    cards[i].style.transform = 'translateY(0) scale(1)'; 
                    cards[i].classList.add('active');
                    updateDisplayStage(cards[i], 0); 
                } else if (i === 1) {
                    cards[i].style.transform = 'translateY(calc(10px + 1vw)) scale(0.95)';
                } else if (i === 2) {
                    cards[i].style.transform = 'translateY(calc(20px + 2vw)) scale(0.90)';
                } else {
                    cards[i].style.transform = 'translateY(calc(30px + 3vw)) scale(0.85)';
                    cards[i].style.opacity = '0'; 
                }
            }
            addEventListenersToActiveCard(); 
        }


        function updateDisplayStage(cardElement, stage) {
            const contentElements = Array.from(cardElement.querySelectorAll('.flashcard-content'));
            contentElements.forEach((el, idx) => {
                if (idx === stage) {
                    el.classList.add('active-display');
                } else {
                    el.classList.remove('active-display');
                }
            });
            cardElement.dataset.currentDisplayStage = stage;
        }

        let currentCardListeners = {}; 
        let isDragging = false; 
        let startX = 0;
        let startY = 0;
        let initialTransform = '';
        let isTap = true; 
        const tapThreshold = 10; 
        let tapTimeout = null; 
        const TAP_DEBOUNCE_DELAY = 300; 

        function addEventListenersToActiveCard() {
            const activeCard = flashcardStack.querySelector('.flashcard.active');
            if (!activeCard) return;

            removeEventListenersFromActiveCard(); 

            const handleCardTapOrClick = (e) => {
                // Ensure the click/tap is not on the audio icon
                if (e.target.classList.contains('audio-icon') || e.target.closest('.audio-icon')) {
                    return; 
                }

                let currentStage = parseInt(activeCard.dataset.currentDisplayStage || 0);
                const nextStage = (currentStage + 1) % NUM_DISPLAY_STAGES; 
                updateDisplayStage(activeCard, nextStage);
            };


            const mousedownHandler = (e) => {
                if (e.button === 0 && !e.target.classList.contains('audio-icon') && !e.target.closest('.audio-icon')) { 
                    isDragging = true;
                    isTap = true; 
                    startX = e.clientX;
                    startY = e.clientY;
                    initialTransform = activeCard.style.transform; 
                    activeCard.style.transition = 'none'; 
                    activeCard.style.cursor = 'grabbing';
                    e.preventDefault(); 
                    document.addEventListener('mousemove', mousemoveHandler);
                    document.addEventListener('mouseup', globalMouseupHandler);
                }
            };
            activeCard.addEventListener('mousedown', mousedownHandler);
            currentCardListeners.mousedown = mousedownHandler;

            const mousemoveHandler = (e) => {
                if (!isDragging) return;
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;

                if (Math.abs(deltaX) > tapThreshold || Math.abs(deltaY) > tapThreshold) {
                    isTap = false;
                }

                const rotation = deltaX / (window.innerWidth / 2) * 20; 
                activeCard.style.transform = `translate(${deltaX}px, ${deltaY}px) rotate(${rotation}deg)`;

                if (deltaX > 50) {
                    activeCard.style.boxShadow = '0 10px 30px rgba(76, 175, 80, 0.4)';
                } else if (deltaX < -50) {
                    activeCard.style.boxShadow = '0 10px 30px rgba(244, 67, 54, 0.4)';
                } else {
                    activeCard.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.1)';
                }
            };

            const globalMouseupHandler = (e) => { 
                if (!isDragging) return;
                isDragging = false;
                document.removeEventListener('mousemove', mousemoveHandler); 
                document.removeEventListener('mouseup', globalMouseupHandler); 

                activeCard.style.transition = 'transform 0.3s ease-out, box-shadow 0.3s ease'; 
                activeCard.style.cursor = 'grab';
                activeCard.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.1)';

                const deltaX = e.clientX - startX;
                const swipeThreshold = 100; 

                if (!isTap && Math.abs(deltaX) > swipeThreshold) { 
                    const direction = deltaX > 0 ? 'right' : 'left';
                    swipeCard(direction);
                } else if (isTap) { 
                    if (!tapTimeout) {
                        handleCardTapOrClick(e); 
                        tapTimeout = setTimeout(() => {
                            tapTimeout = null;
                        }, TAP_DEBOUNCE_DELAY);
                    }
                } else {
                    activeCard.style.transform = initialTransform; 
                }
            };

            const touchstartHandler = (e) => {
                if (e.touches.length === 1 && !e.target.classList.contains('audio-icon') && !e.target.closest('.audio-icon')) { 
                    isDragging = true;
                    isTap = true; 
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                    initialTransform = activeCard.style.transform;
                    activeCard.style.transition = 'none';
                    e.preventDefault(); 
                    document.addEventListener('touchmove', touchmoveHandler, { passive: false });
                    document.addEventListener('touchend', globalTouchendHandler);
                    document.addEventListener('touchcancel', globalTouchendHandler);
                }
            };
            activeCard.addEventListener('touchstart', touchstartHandler);
            currentCardListeners.touchstart = touchstartHandler;

            const touchmoveHandler = (e) => {
                if (!isDragging || e.touches.length === 0) return; 
                const deltaX = e.touches[0].clientX - startX;
                const deltaY = e.touches[0].clientY - startY;

                if (Math.abs(deltaX) > tapThreshold || Math.abs(deltaY) > tapThreshold) {
                    isTap = false;
                }

                const rotation = deltaX / (window.innerWidth / 2) * 20;
                activeCard.style.transform = `translate(${deltaX}px, ${deltaY}px) rotate(${rotation}deg)`;

                if (deltaX > 50) {
                    activeCard.style.boxShadow = '0 10px 30px rgba(76, 175, 80, 0.4)';
                } else if (deltaX < -50) {
                    activeCard.style.boxShadow = '0 10px 30px rgba(244, 67, 54, 0.4)';
                } else {
                    activeCard.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.1)';
                }
            };

            const globalTouchendHandler = (e) => {
                if (!isDragging) return;
                isDragging = false;
                document.removeEventListener('touchmove', touchmoveHandler);
                document.removeEventListener('touchend', globalTouchendHandler);
                document.removeEventListener('touchcancel', globalTouchendHandler);

                activeCard.style.transition = 'transform 0.3s ease-out, box-shadow 0.3s ease'; 
                activeCard.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.1)';

                const deltaX = e.changedTouches[0].clientX - startX;
                const swipeThreshold = 100;

                if (!isTap && Math.abs(deltaX) > swipeThreshold) { 
                    const direction = deltaX > 0 ? 'right' : 'left';
                    swipeCard(direction);
                } else if (isTap) { 
                    if (!tapTimeout) {
                        handleCardTapOrClick(e); 
                        tapTimeout = setTimeout(() => {
                            tapTimeout = null;
                        }, TAP_DEBOUNCE_DELAY);
                    }
                } else {
                    activeCard.style.transform = initialTransform;
                }
            };
        }

        function removeEventListenersFromActiveCard() {
            const activeCard = flashcardStack.querySelector('.flashcard.active');
            if (!activeCard) return;

            if (currentCardListeners.mousedown) activeCard.removeEventListener('mousedown', currentCardListeners.mousedown);
            document.removeEventListener('mousemove', currentCardListeners.mousemoveHandler); 
            document.removeEventListener('mouseup', currentCardListeners.globalMouseupHandler);
            
            if (currentCardListeners.touchstart) activeCard.removeEventListener('touchstart', currentCardListeners.touchstart);
            document.removeEventListener('touchmove', currentCardListeners.touchmoveHandler); 
            document.removeEventListener('touchend', currentCardListeners.globalTouchendHandler);
            document.removeEventListener('touchcancel', currentCardListeners.globalTouchendHandler);

            currentCardListeners = {}; 
        }
        
        // --- Audio Play Function (now using local MP3s) ---
        function playAudioForCard(cardDataIndex) {
            if (!isNaN(cardDataIndex) && flashcardsData[cardDataIndex] && flashcardsData[cardDataIndex].char) { 
                const charToSpeak = flashcardsData[cardDataIndex].char;
                const audioFilePath = `${charToSpeak}.mp3`; // Assuming MP3s are named after the character, e.g., "Êàë.mp3"
                
                audioPlayer.src = audioFilePath;
                audioPlayer.load(); // Load the new audio file
                audioPlayer.play().catch(error => {
                    console.error("Error playing audio:", error);
                    // Minimal alert, hoping the explicit click allows it
                    alert("Impossible de lire l'audio. Assurez-vous que le fichier MP3 existe et est bien nomm√©.");
                });
            } else {
                console.warn("No character or audio path available for playback.");
            }
        }

        // --- Score Overlay Logic ---
        function updateScoreDisplay() {
            const notMasteredColumn = document.querySelector('.score-column.not-mastered');
            const mediumColumn = document.querySelector('.score-column.medium');
            const masteredColumn = document.querySelector('.score-column.mastered');

            notMasteredColumn.innerHTML = '<h4>√Ä Travailler (0-1)</h4>';
            mediumColumn.innerHTML = '<h4>√Ä Revoir (2-3)</h4>';
            masteredColumn.innerHTML = '<h4>Ma√Ætris√© (4-5)</h4>';

            const sortedCards = flashcardsData
                .map((data, index) => ({ ...data, score: cardScores[index], originalIndex: index }))
                .sort((a, b) => a.score - b.score); 

            sortedCards.forEach(card => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('score-item');
                itemDiv.innerHTML = `
                    <span class="score-char">${card.char}</span>
                    <span class="score-details">${card.pinyin} (${card.score})</span>
                `;

                if (card.score <= 1) {
                    notMasteredColumn.appendChild(itemDiv);
                } else if (card.score <= 3) {
                    mediumColumn.appendChild(itemDiv);
                } else {
                    masteredColumn.appendChild(itemDiv);
                }
            });
        }

        function showScoreOverlay() {
            updateScoreDisplay();
            scoreOverlay.classList.add('visible');
        }

        function hideScoreOverlay() {
            scoreOverlay.classList.remove('visible');
        }

        // --- Home Indicator Bar Swipe Logic ---
        let touchStartY = 0;
        let isSwipingUp = false;
        const SWIPE_UP_THRESHOLD = -50; 

        homeIndicatorBar.addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
            isSwipingUp = true;
            e.preventDefault(); 
        }, { passive: false });

        homeIndicatorBar.addEventListener('touchmove', (e) => {
            if (!isSwipingUp) return;
            const currentY = e.touches[0].clientY;
            const deltaY = currentY - touchStartY;

            if (deltaY < SWIPE_UP_THRESHOLD) {
                showScoreOverlay();
                isSwipingUp = false; 
            }
        });

        homeIndicatorBar.addEventListener('touchend', () => {
            isSwipingUp = false;
        });

        homeIndicatorBar.addEventListener('touchcancel', () => {
            isSwipingUp = false;
        });
        
        homeIndicatorBar.addEventListener('click', showScoreOverlay); 


        // Close overlay on click outside modal or Escape key
        scoreOverlay.addEventListener('click', (e) => {
            if (e.target === scoreOverlay) { 
                hideScoreOverlay();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && scoreOverlay.classList.contains('visible')) {
                hideScoreOverlay();
            }
        });

        // --- Reset Button Logic ---
        resetButton.addEventListener('click', () => {
            if (confirm("√ätes-vous s√ªr de vouloir r√©initialiser tous les scores ? Cette action est irr√©versible.")) {
                for (let i = 0; i < cardScores.length; i++) {
                    cardScores[i] = INITIAL_SCORE;
                }
                updateScoreDisplay(); 
                showFeedback('Scores r√©initialis√©s !', 'incorrect'); 
            }
        });


        // Initial setup
        document.addEventListener('DOMContentLoaded', initializeCardStack);
    </script>
</body>
</html>