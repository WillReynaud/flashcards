<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcards Mandarin</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
            overflow: hidden; /* Prevent scrollbars */
        }

        #flashcard-stack {
            width: 90vw;
            max-width: 500px;
            height: 60vh;
            max-height: 400px;
            position: relative; /* Container for stacked cards */
            display: flex; /* To center the cards within the stack */
            justify-content: center;
            align-items: center;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .flashcard {
            width: 100%;
            height: 100%;
            position: absolute; /* Stack them on top of each other */
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            background-color: #fff;
            overflow: hidden;
            transition: transform 0.3s ease-out, box-shadow 0.3s ease, opacity 0.3s ease; 
            transform-origin: center center; /* Ensure rotation around center */
        }

        /* Styles for stacked effect */
        .flashcard:nth-child(2) { 
            transform: translateY(calc(10px + 1vw)) scale(0.95);
            opacity: 0.8;
            z-index: 0; 
        }
        .flashcard:nth-child(3) { 
            transform: translateY(calc(20px + 2vw)) scale(0.90);
            opacity: 0.6;
            z-index: -1; 
        }

        .flashcard.active {
            z-index: 1; 
            cursor: grab;
        }

        .flashcard-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out; 
            color: #000; 
        }

        .flashcard-content.active-display {
            opacity: 1;
            visibility: visible;
        }

        .flashcard-front h2 {
            font-size: clamp(4em, 10vw, 8em);
            font-weight: bold;
        }

        .flashcard-middle h2 {
            font-size: clamp(2em, 5vw, 3em);
        }

        .flashcard-back h2 {
            font-size: clamp(1.8em, 4vw, 2.5em);
        }

        .flashcard-content h2 {
            margin: 0;
            line-height: 1.2;
            overflow-wrap: break-word;
            word-break: break-word;
            white-space: normal;
            padding: 10px;
            color: #000; 
        }

        .audio-zone { 
            position: absolute;
            bottom: 0;
            right: 0;
            width: 30%;
            height: 30%;
            cursor: pointer;
            z-index: 10; 
        }

        #feedback {
            position: fixed;
            top: 20px;
            font-size: 1.5em;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            z-index: 100;
        }

        #feedback.show {
            opacity: 1;
        }

        #feedback.correct {
            color: #4CAF50;
            transform: translateY(0);
        }

        #feedback.incorrect {
            color: #F44336;
            transform: translateY(0);
        }

        /* --- Overlay Styles --- */
        #score-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: flex-end; /* Align modal to bottom */
            z-index: 200;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        #score-overlay.visible {
            visibility: visible;
            opacity: 1;
        }

        #score-modal {
            background-color: #fff;
            border-top-left-radius: 20px; /* Rounded top corners */
            border-top-right-radius: 20px;
            padding: 30px;
            width: 100%; /* Full width at bottom */
            max-width: 800px;
            height: 80vh; /* Takes 80% of screen height */
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden; 

            /* Initial state for slide-up animation */
            transform: translateY(100%); 
            transition: transform 0.3s ease-out;
        }

        #score-overlay.visible #score-modal {
            transform: translateY(0%); /* Slide up to visible position */
        }

        #score-modal h3 {
            text-align: center;
            margin-top: 0;
            color: #333;
            font-size: 1.8em;
            margin-bottom: 20px;
        }

        #score-columns {
            display: flex;
            flex-grow: 1; 
            gap: 20px;
            overflow-y: auto; 
        }

        .score-column {
            flex: 1;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            overflow-y: auto; 
        }

        .score-column.mastered {
            background-color: #e6ffe6; 
            border: 1px solid #4CAF50;
        }

        .score-column.medium {
            background-color: #fff8e1; 
            border: 1px solid #FFC107;
        }

        .score-column.not-mastered {
            background-color: #ffe6e6; 
            border: 1px solid #F44336;
        }

        .score-column h4 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2em;
            color: #333;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dotted #ccc;
            font-size: 1em;
        }

        .score-item:last-child {
            border-bottom: none;
        }

        .score-char {
            font-weight: bold;
            font-size: 1.1em;
        }

        .score-details {
            color: #666;
            font-size: 0.9em;
        }

        /* Home Indicator Bar */
        #home-indicator-bar {
            position: fixed;
            bottom: 8px; /* A little bit from the very bottom */
            left: 50%;
            transform: translateX(-50%);
            width: 130px; /* Standard iPhone bar width */
            height: 5px; /* Standard iPhone bar height */
            background-color: #000;
            border-radius: 100px; /* Fully rounded corners */
            z-index: 150; /* Above cards, below overlay */
            cursor: grab;
        }
    </style>
</head>
<body>
    <div id="feedback"></div>
    <div id="flashcard-stack">
        </div>

    <audio id="audio-player"></audio>

    <div id="home-indicator-bar"></div>

    <div id="score-overlay">
        <div id="score-modal">
            <h3>Votre Progression</h3>
            <div id="score-columns">
                <div class="score-column not-mastered">
                    <h4>À Travailler (0-1)</h4>
                </div>
                <div class="score-column medium">
                    <h4>À Revoir (2-3)</h4>
                </div>
                <div class="score-column mastered">
                    <h4>Maîtrisé (4-5)</h4>
                </div>
            </div>
        </div>
    </div>

    <script>
        const flashcardsData = [
            { char: "我", pinyin: "wǒ", translation: "je / moi" },
            { char: "你", pinyin: "nǐ", translation: "tu / toi" },
            { char: "他", pinyin: "tā", translation: "il / lui" },
            { char: "她", pinyin: "tā", translation: "elle" },
            { char: "我们", pinyin: "wǒmen", translation: "nous" },
            { char: "你们", pinyin: "nǐmen", translation: "vous" },
            { char: "他们", pinyin: "tāmen", translation: "ils / eux" },
            { char: "她们", pinyin: "tāmen", translation: "elles" },
            { char: "姓", pinyin: "xìng", translation: "s'appeler (nom de famille)" },
            { char: "叫", pinyin: "jiào", translation: "s'appeler (prénom)" },
            { char: "学", pinyin: "xué", translation: "étudier" },
            { char: "是", pinyin: "shì", translation: "être" },
            { char: "生", pinyin: "shēng", translation: "naître / élève" },
            { char: "有", pinyin: "yǒu", translation: "avoir" },
            { char: "说", pinyin: "shuō", translation: "dire / parler" },
            { char: "在", pinyin: "zài", translation: "être (quelque part)" },
            { char: "去", pinyin: "qù", translation: "aller" },
            { char: "来", pinyin: "lái", translation: "venir" },
            { char: "回", pinyin: "huí", translation: "revenir" },
            { char: "住", pinyin: "zhù", translation: "habiter / demeurer" },
            { char: "工作", pinyin: "gōngzuò", translation: "travailler" },
            { char: "休息", pinyin: "xiūxi", translation: "se reposer" },
            { char: "找", pinyin: "zhǎo", translation: "chercher" },
            { char: "问", pinyin: "wèn", translation: "demander" },
            { char: "喝", pinyin: "hē", translation: "boire" },
            { char: "想", pinyin: "xiâng", translation: "vouloir" },
            { char: "知道", pinyin: "zhīdào", translation: "savoir" },
            { char: "看", pinyin: "kàn", translation: "voir / observer" },
            { char: "不", pinyin: "bù", translation: "négation" },
            { char: "没", pinyin: "méi", translation: "négation (passé)" },
            { char: "呢", pinyin: "ne", translation: "particule interrogative" },
            { char: "吗", pinyin: "ma", translation: "particule interrogative" },
            { char: "吧", pinyin: "ba", translation: "particule de suggestion" },
            { char: "什么", pinyin: "shénme", translation: "quoi / que" },
            { char: "哪", pinyin: "nǎ", translation: "quel / lequel" },
            { char: "几", pinyin: "jǐ", translation: "combien (petit nombre) / quelques" },
            { char: "谁", pinyin: "shéi", translation: "qui ?" },
            { char: "也", pinyin: "yě", translation: "aussi" },
            { char: "这", pinyin: "zhè", translation: "ce / cette" },
            { char: "的", pinyin: "de", translation: "particule possessive" },
            { char: "个", pinyin: "gè", translation: "classificateur général" },
            { char: "两", pinyin: "liǎng", translation: "deux (quantité)" },
            { char: "本", pinyin: "běn", translation: "classificateur pour les livres / racine / origine / fondamentale" },
            { char: "口", pinyin: "kǒu", translation: "classificateur membres famille / bouche" },
            { char: "一", pinyin: "yī", translation: "un" },
            { char: "二", pinyin: "èr", translation: "deux" },
            { char: "三", pinyin: "sān", translation: "trois" },
            { char: "四", pinyin: "sì", translation: "quatre" },
            { char: "五", pinyin: "wǔ", translation: "cinq" },
            { char: "六", pinyin: "liù", translation: "six" },
            { char: "七", pinyin: "qī", translation: "sept" },
            { char: "八", pinyin: "bā", translation: "huit" },
            { char: "九", pinyin: "jiǔ", translation: "neuf" },
            { char: "十", pinyin: "shí", translation: "dix" },
            { char: "多少", pinyin: "duōshǎo", translation: "combien ?" },
            { char: "多大", pinyin: "duō dà", translation: "quel âge ?" },
            { char: "岁", pinyin: "suì", translation: "âge" },
            { char: "几岁", pinyin: "jǐ suì", translation: "Pour les enfants (moins de 10 ans)" },
            { char: "您多大年纪", pinyin: "Nín duō dà niánjì ?", translation: "Pour être poli avec des personnes âgées" },
            { char: "在", pinyin: "zài", translation: "être (quelque part)" },
            { char: "哪儿", pinyin: "nǎr", translation: "où" },
            { char: "年", pinyin: "nián", translation: "année" },
            { char: "星期", pinyin: "xīngqī", translation: "semaine" },
            { char: "日", pinyin: "rì", translation: "jour" },
            { char: "号", pinyin: "hào", translation: "jour/date (oral)" },
            { char: "月", pinyin: "yuè", translation: "mois" },
            { char: "星期日", pinyin: "xīngqīrì", translation: "dimanche" },
            { char: "生日", pinyin: "shēngrì", translation: "anniversaire" },
            { char: "几", pinyin: "jǐ", translation: "combien (petit nombre / heure / âge)" },
            { char: "今天", pinyin: "jīntiān", translation: "aujourd'hui" },
            { char: "明天", pinyin: "míngtiān", translation: "demain" },
            { char: "昨天", pinyin: "zuótiānhier", translation: "hier" },
            { char: "上午", pinyin: "shàngwǔ", translation: "matin" },
            { char: "中午", pinyin: "zhōngwǔ", translation: "midi" },
            { char: "下午", pinyin: "xiàwǔ", translation: "après-midi" },
            { char: "早上", pinyin: "zǎoshang", translation: "matin (très tôt)" },
            { char: "晚上", pinyin: "wǎnshang", translation: "soir" },
            { char: "今年", pinyin: "jīnnián", translation: "cette année" },
            { char: "明年", pinyin: "míngnián", translation: "l'année prochaine" },
            { char: "去年", pinyin: "qùnián", translation: "l'année dernière" },
            { char: "钟", pinyin: "zhōng", translation: "horloge / utilisé pour l'heure précise" },
            { char: "点", pinyin: "diǎn", translation: "point / unité de compte pour l'heure" },
            { char: "分", pinyin: "fēn", translation: "minute" },
            { char: "刻", pinyin: "kè", translation: "quart d'heure" },
            { char: "半", pinyin: "bàn", translation: "demi (30 minutes)" },
            { char: "三点钟", pinyin: "sān diǎn zhōng", translation: "3 heures" },
            { char: "三点五分", pinyin: "sān diǎn wǔ fēn", translation: "3h05" },
            { char: "六点一刻", pinyin: "liù diǎn yī kè", translation: "6h15" },
            { char: "六点半", pinyin: "liù diǎn bàn", translation: "6h30" },
            { char: "七点差一刻", pinyin: "qī diǎn chà yī kè", translation: "6h45" },
            { char: "六点三刻", pinyin: "liù diǎn sān kè", translation: "6h45 (alternative)" },
            { char: "好", pinyin: "hǎo", translation: "bien" },
            { char: "大", pinyin: "dà", translation: "grand" },
            { char: "小", pinyin: "xiǎo", translation: "petit" },
            { char: "老", pinyin: "lǎo", translation: "vieux" },
            { char: "过", pinyin: "guò", translation: "(passé d'expérience)" },
            { char: "名字", pinyin: "míngzi", translation: "prénom" },
            { char: "姓", pinyin: "xìng", translation: "nom de famille" },
            { char: "人", pinyin: "rén", translation: "personne" },
            { char: "这个人", pinyin: "zhè ge rén", translation: "cette personne-ci" },
            { char: "那个人", pinyin: "nà ge rén", translation: "cette personne-là" },
            { char: "都", pinyin: "dōu", translation: "tous / tout" },
            { char: "朋友", pinyin: "péngyǒu", translation: "ami" },
            { char: "男朋友", pinyin: "nán péngyǒu", translation: "petit ami" },
            { char: "女朋友", pinyin: "nǚ péngyǒu", translation: "petite amie" },
            { char: "姐姐", pinyin: "jiějie", translation: "grande sœur" },
            { char: "妹妹", pinyin: "mèimei", translation: "petite sœur" },
            { char: "哥哥", pinyin: "gēge", translation: "grand frère" },
            { char: "弟弟", pinyin: "dìdi", translation: "petit frère" },
            { char: "爸爸", pinyin: "bàba", translation: "papa" },
            { char: "妈妈", pinyin: "māmā", translation: "maman" },
            { char: "孩子", pinyin: "háizi", translation: "enfant" },
            { char: "父母", pinyin: "fùmǔ", translation: "parents" },
            { char: "学生", pinyin: "xuéshēng", translation: "étudiant" },
            { char: "大学生", pinyin: "dàxuéshēng", translation: "étudiant (supérieur)" },
            { char: "中学生", pinyin: "zhōngxuéshēng", translation: "élève du secondaire" },
            { char: "小学生", pinyin: "xiǎoxuéshēng", translation: "élève du primaire" },
            { char: "博士", pinyin: "bóshì", translation: "docteur (titre académique)" },
            { char: "汉语", pinyin: "hànyǔ", translation: "langue chinoise" },
            { char: "日语", pinyin: "rìyǔ", translation: "langue japonaise" },
            { char: "法语", pinyin: "fǎyǔ", translation: "langue française" },
            { char: "英语", pinyin: "yīngyǔ", translation: "langue anglaise" },
            { char: "德语", pinyin: "déyǔ", translation: "langue allemande" },
            { char: "文", pinyin: "wén", translation: "écriture / langue" },
            { char: "历史", pinyin: "lìshǐ", translation: "histoire" },
            { char: "艺术", pinyin: "yìshù", translation: "art" },
            { char: "文学", pinyin: "wénxué", translation: "littérature" },
            { char: "数学", pinyin: "shùxué", translation: "mathématiques" },
            { char: "中国", pinyin: "zhōngguó", translation: "Chine" },
            { char: "北京", pinyin: "běijīng", translation: "Pékin" },
            { char: "法国", pinyin: "fǎguó", translation: "France" },
            { char: "车", pinyin: "chē", translation: "véhicule" },
            { char: "汽车", pinyin: "qìchē", translation: "voiture" },
            { char: "自行车", pinyin: "zìxíngchē", translation: "vélo" },
            { char: "国", pinyin: "guó", translation: "pays" },
            { char: "人口", pinyin: "rénkǒupopulation", translation: "population" },
            { char: "北方人", pinyin: "běifāngréngens", translation: "gens du nord" },
            { char: "南方人", pinyin: "nánfāngréngens", translation: "gens du sud" },
            { char: "中", pinyin: "zhōng", translation: "au centre / milieu" },
            { char: "北", pinyin: "běi", translation: "nord" },
            { char: "南", pinyin: "nán", translation: "sud" },
            { char: "东", pinyin: "dōng", translation: "est" },
            { char: "西", pinyin: "xī", translation: "ouest" },
            { char: "茶", pinyin: "chá", translation: "thé" },
            { char: "是", pinyin: "shì", translation: "Oui" },
            { char: "不", pinyin: "bù", translation: "non" },
            { char: "红", pinyin: "hóng", translation: "rouge" },
            { char: "绿", pinyin: "lü", translation: "Vert" },
            { char: "奶", pinyin: "nǎi", translation: "lait" }
        ];

        const cardScores = new Array(flashcardsData.length).fill(2); 
        const SCORE_MAX = 5;
        const SCORE_MIN = 0;
        const NUM_CARDS_IN_STACK = 3; 

        const flashcardStack = document.getElementById('flashcard-stack');
        const audioPlayer = document.getElementById('audio-player');
        const feedbackDisplay = document.getElementById('feedback');
        const scoreOverlay = document.getElementById('score-overlay');
        const homeIndicatorBar = document.getElementById('home-indicator-bar');
        
        let cardDataQueue = []; 

        function showFeedback(message, type) {
            feedbackDisplay.textContent = message;
            feedbackDisplay.className = 'show ' + type;
            setTimeout(() => {
                feedbackDisplay.className = '';
            }, 1000);
        }

        function getWeightedRandomCardIndex() {
            let weightedIndexes = [];
            for (let i = 0; i < flashcardsData.length; i++) {
                const weight = SCORE_MAX - cardScores[i] + 1;
                for (let j = 0; j < weight; j++) {
                    weightedIndexes.push(i);
                }
            }
            if (weightedIndexes.length === 0 && flashcardsData.length > 0) {
                 return Math.floor(Math.random() * flashcardsData.length);
            } else if (flashcardsData.length === 0) {
                return -1;
            }
            const randomIndex = Math.floor(Math.random() * weightedIndexes.length);
            return weightedIndexes[randomIndex];
        }

        function fillCardQueue() {
            while (cardDataQueue.length < NUM_CARDS_IN_STACK + 1) { 
                let newIndex = getWeightedRandomCardIndex();
                if (newIndex !== -1) {
                    const displayedCardDataIndices = Array.from(flashcardStack.children).map(cardEl => parseInt(cardEl.dataset.cardDataIndex));
                    if (!displayedCardDataIndices.includes(newIndex)) {
                        cardDataQueue.push(newIndex);
                    } else {
                        let foundUnique = false;
                        for(let i = 0; i < flashcardsData.length; i++) {
                            if (!displayedCardDataIndices.includes(i) && !cardDataQueue.includes(i)) {
                                newIndex = i;
                                cardDataQueue.push(newIndex);
                                foundUnique = true;
                                break;
                            }
                        }
                        if (!foundUnique) {
                            console.warn("Could not find a unique card to add to queue.");
                            break;
                        }
                    }
                } else {
                    console.warn("No more cards to add to queue.");
                    break;
                }
            }
        }


        function createFlashcardElement(cardDataIndex, domIndex) {
            const flashcardDiv = document.createElement('div');
            flashcardDiv.classList.add('flashcard');
            flashcardDiv.id = `flashcard-${domIndex}`;
            flashcardDiv.dataset.cardDataIndex = cardDataIndex; 

            const cardContents = ['front', 'middle', 'back'];
            const cardValues = [
                flashcardsData[cardDataIndex].char,
                flashcardsData[cardDataIndex].pinyin,
                flashcardsData[cardDataIndex].translation
            ];

            cardContents.forEach((type, i) => {
                const contentDiv = document.createElement('div');
                contentDiv.classList.add('flashcard-content', `flashcard-${type}`);
                contentDiv.id = `card-${domIndex}-${type}`;
                const h2 = document.createElement('h2');
                h2.textContent = cardValues[i];
                contentDiv.appendChild(h2);
                flashcardDiv.appendChild(contentDiv);
            });

            const audioZoneDiv = document.createElement('div');
            audioZoneDiv.classList.add('audio-zone'); 
            flashcardDiv.appendChild(audioZoneDiv);

            return flashcardDiv;
        }

        function initializeCardStack() {
            fillCardQueue();
            flashcardStack.innerHTML = ''; 
            for (let i = 0; i < NUM_CARDS_IN_STACK; i++) {
                if (cardDataQueue.length > i) {
                    const cardElement = createFlashcardElement(cardDataQueue[i], i);
                    flashcardStack.appendChild(cardElement);
                }
            }
            if (flashcardStack.children.length > 0) {
                flashcardStack.children[0].classList.add('active');
                updateDisplayStage(flashcardStack.children[0], 0); 
            }
            addEventListenersToActiveCard();
        }

        function swipeCard(direction, onComplete) {
            const activeCard = flashcardStack.querySelector('.flashcard.active');
            if (!activeCard) return;

            removeEventListenersFromActiveCard(); 

            const swipedCardDataIndex = parseInt(activeCard.dataset.cardDataIndex);

            activeCard.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out'; 
            let rotation = direction === 'right' ? 'rotate(10deg)' : 'rotate(-10deg)';
            let translateX = direction === 'right' ? '150%' : '-150%';
            activeCard.style.transform = `translateX(${translateX}) translateY(0) ${rotation}`;
            activeCard.style.opacity = '0';
            activeCard.classList.remove('active');

            if (swipedCardDataIndex !== undefined && swipedCardDataIndex !== -1) {
                 if (direction === 'right') {
                    if (cardScores[swipedCardDataIndex] < SCORE_MAX) cardScores[swipedCardDataIndex]++;
                    showFeedback('Bravo !', 'correct');
                 } else { 
                    if (cardScores[swipedCardDataIndex] > SCORE_MIN) cardScores[swipedCardDataIndex]--;
                    showFeedback('À revoir !', 'incorrect');
                 }
            }
            
            activeCard.addEventListener('transitionend', () => {
                activeCard.remove(); 

                cardDataQueue.shift(); 
                fillCardQueue(); 

                if (cardDataQueue.length > NUM_CARDS_IN_STACK - 1) { 
                    const newCardDataIndex = cardDataQueue[NUM_CARDS_IN_STACK - 1]; 
                    const newCardElement = createFlashcardElement(newCardDataIndex, flashcardStack.children.length); 
                    flashcardStack.appendChild(newCardElement);
                }

                applyStackStyles();
                if (onComplete) onComplete();

            }, { once: true });
        }

        function applyStackStyles() {
            const cards = flashcardStack.children;
            for (let i = 0; i < cards.length; i++) {
                cards[i].style.transition = 'transform 0.2s ease-out, opacity 0.2s ease-out, box-shadow 0.3s ease'; 
                cards[i].style.opacity = '1'; 

                cards[i].style.transform = ''; 
                cards[i].classList.remove('active'); 

                if (i === 0) {
                    cards[i].style.transform = 'translateY(0) scale(1)'; 
                    cards[i].classList.add('active');
                    updateDisplayStage(cards[i], 0); 
                    addEventListenersToActiveCard(); 
                } else if (i === 1) {
                    cards[i].style.transform = 'translateY(calc(10px + 1vw)) scale(0.95)';
                } else if (i === 2) {
                    cards[i].style.transform = 'translateY(calc(20px + 2vw)) scale(0.90)';
                } else {
                    cards[i].style.transform = 'translateY(calc(30px + 3vw)) scale(0.85)';
                    cards[i].style.opacity = '0'; 
                }
            }
        }


        function updateDisplayStage(cardElement, stage) {
            const contentElements = Array.from(cardElement.querySelectorAll('.flashcard-content'));
            contentElements.forEach((el, idx) => {
                if (idx === stage) {
                    el.classList.add('active-display');
                } else {
                    el.classList.remove('active-display');
                }
            });
            cardElement.dataset.currentDisplayStage = stage;
        }

        let currentCardListeners = {}; 

        function addEventListenersToActiveCard() {
            const activeCard = flashcardStack.querySelector('.flashcard.active');
            if (!activeCard) return;

            const clickHandler = (e) => {
                const audioZone = activeCard.querySelector('.audio-zone');
                const rect = audioZone.getBoundingClientRect();
                if (e.clientX >= rect.left && e.clientX <= rect.right &&
                    e.clientY >= rect.top && e.clientY <= rect.bottom) {
                    e.stopPropagation(); 
                    const currentCardDataIndex = parseInt(activeCard.dataset.cardDataIndex);
                    if (!isNaN(currentCardDataIndex) && flashcardsData[currentCardDataIndex]) {
                         audioPlayer.src = `audios/${flashcardsData[currentCardDataIndex].char}.mp3`;
                         playAudio();
                    }
                    return;
                }

                let currentStage = parseInt(activeCard.dataset.currentDisplayStage || 0);
                const nextStage = (currentStage + 1) % 3; 
                updateDisplayStage(activeCard, nextStage);
            };
            activeCard.addEventListener('click', clickHandler);
            currentCardListeners.click = clickHandler;

            let startX = 0;
            let startY = 0;
            let isDragging = false;
            let initialTransform = ''; 

            const mousedownHandler = (e) => {
                if (e.button === 0) { 
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    initialTransform = activeCard.style.transform; 
                    activeCard.style.transition = 'none'; 
                    activeCard.style.cursor = 'grabbing';
                    e.preventDefault();
                }
            };
            activeCard.addEventListener('mousedown', mousedownHandler);
            currentCardListeners.mousedown = mousedownHandler;

            const mousemoveHandler = (e) => {
                if (!isDragging) return;
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                const rotation = deltaX / (window.innerWidth / 2) * 20; 
                activeCard.style.transform = `translate(${deltaX}px, ${deltaY}px) rotate(${rotation}deg)`;

                if (deltaX > 50) {
                    activeCard.style.boxShadow = '0 10px 30px rgba(76, 175, 80, 0.4)';
                } else if (deltaX < -50) {
                    activeCard.style.boxShadow = '0 10px 30px rgba(244, 67, 54, 0.4)';
                } else {
                    activeCard.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.1)';
                }
            };
            document.addEventListener('mousemove', mousemoveHandler); 
            currentCardListeners.mousemove = mousemoveHandler;

            const mouseupHandler = (e) => {
                if (!isDragging) return;
                isDragging = false;
                document.removeEventListener('mousemove', mousemoveHandler); 
                
                activeCard.style.transition = 'transform 0.3s ease-out, box-shadow 0.3s ease'; 
                activeCard.style.cursor = 'grab';
                activeCard.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.1)';

                const deltaX = e.clientX - startX;
                const swipeThreshold = 100; 

                if (Math.abs(deltaX) > swipeThreshold) {
                    const direction = deltaX > 0 ? 'right' : 'left';
                    swipeCard(direction);
                } else {
                    activeCard.style.transform = initialTransform; 
                }
            };
            document.addEventListener('mouseup', mouseupHandler); 
            currentCardListeners.mouseup = mouseupHandler;


            const touchstartHandler = (e) => {
                isDragging = true;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                initialTransform = activeCard.style.transform;
                activeCard.style.transition = 'none';
                e.preventDefault();
            };
            activeCard.addEventListener('touchstart', touchstartHandler);
            currentCardListeners.touchstart = touchstartHandler;

            const touchmoveHandler = (e) => {
                if (!isDragging) return;
                const deltaX = e.touches[0].clientX - startX;
                const deltaY = e.touches[0].clientY - startY;
                const rotation = deltaX / (window.innerWidth / 2) * 20;
                activeCard.style.transform = `translate(${deltaX}px, ${deltaY}px) rotate(${rotation}deg)`;

                if (deltaX > 50) {
                    activeCard.style.boxShadow = '0 10px 30px rgba(76, 175, 80, 0.4)';
                } else if (deltaX < -50) {
                    activeCard.style.boxShadow = '0 10px 30px rgba(244, 67, 54, 0.4)';
                } else {
                    activeCard.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.1)';
                }
            };
            document.addEventListener('touchmove', touchmoveHandler);
            currentCardListeners.touchmove = touchmoveHandler;

            const touchendHandler = (e) => {
                if (!isDragging) return;
                isDragging = false;
                document.removeEventListener('touchmove', touchmoveHandler);
                
                activeCard.style.transition = 'transform 0.3s ease-out, box-shadow 0.3s ease'; 
                activeCard.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.1)';

                const deltaX = e.changedTouches[0].clientX - startX;
                const swipeThreshold = 100;

                if (Math.abs(deltaX) > swipeThreshold) {
                    const direction = deltaX > 0 ? 'right' : 'left';
                    swipeCard(direction);
                } else {
                    activeCard.style.transform = initialTransform;
                }
            };
            document.addEventListener('touchend', touchendHandler);
            currentCardListeners.touchend = touchendHandler;
        }

        function removeEventListenersFromActiveCard() {
            const activeCard = flashcardStack.querySelector('.flashcard.active');
            if (activeCard) {
                if (currentCardListeners.click) activeCard.removeEventListener('click', currentCardListeners.click);
                if (currentCardListeners.mousedown) activeCard.removeEventListener('mousedown', currentCardListeners.mousedown);
                if (currentCardListeners.mousemove) document.removeEventListener('mousemove', currentCardListeners.mousemove);
                if (currentCardListeners.mouseup) document.removeEventListener('mouseup', currentCardListeners.mouseup);
                if (currentCardListeners.touchstart) activeCard.removeEventListener('touchstart', currentCardListeners.touchstart);
                if (currentCardListeners.touchmove) document.removeEventListener('touchmove', currentCardListeners.touchmove);
                if (currentCardListeners.touchend) document.removeEventListener('touchend', currentCardListeners.touchend);
            }
            currentCardListeners = {}; 
        }
        
        function playAudio() {
            if (!audioPlayer.paused) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
            }
            audioPlayer.play().catch(e => console.error("Error playing audio:", e));
        }

        // --- Score Overlay Logic ---
        function updateScoreDisplay() {
            const notMasteredColumn = document.querySelector('.score-column.not-mastered');
            const mediumColumn = document.querySelector('.score-column.medium');
            const masteredColumn = document.querySelector('.score-column.mastered');

            notMasteredColumn.innerHTML = '<h4>À Travailler (0-1)</h4>';
            mediumColumn.innerHTML = '<h4>À Revoir (2-3)</h4>';
            masteredColumn.innerHTML = '<h4>Maîtrisé (4-5)</h4>';

            const sortedCards = flashcardsData
                .map((data, index) => ({ ...data, score: cardScores[index], originalIndex: index }))
                .sort((a, b) => a.score - b.score); 

            sortedCards.forEach(card => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('score-item');
                itemDiv.innerHTML = `
                    <span class="score-char">${card.char}</span>
                    <span class="score-details">${card.pinyin} (${card.score})</span>
                `;

                if (card.score <= 1) {
                    notMasteredColumn.appendChild(itemDiv);
                } else if (card.score <= 3) {
                    mediumColumn.appendChild(itemDiv);
                } else {
                    masteredColumn.appendChild(itemDiv);
                }
            });
        }

        function showScoreOverlay() {
            updateScoreDisplay();
            scoreOverlay.classList.add('visible');
        }

        function hideScoreOverlay() {
            scoreOverlay.classList.remove('visible');
        }

        // --- Home Indicator Bar Swipe Logic ---
        let touchStartY = 0;
        let isSwipingUp = false;
        const SWIPE_UP_THRESHOLD = -50; // pixels, negative for upward movement

        homeIndicatorBar.addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
            isSwipingUp = true;
            e.preventDefault(); // Prevent scrolling on touch devices
        }, { passive: false });

        homeIndicatorBar.addEventListener('touchmove', (e) => {
            if (!isSwipingUp) return;
            const currentY = e.touches[0].clientY;
            const deltaY = currentY - touchStartY;

            // Optional: Provide visual feedback during swipe
            // You could adjust the position of the modal slightly here, for example
            // scoreOverlay.style.transform = `translateY(${Math.max(0, 100 + deltaY)}%)`;

            if (deltaY < SWIPE_UP_THRESHOLD) {
                showScoreOverlay();
                isSwipingUp = false; // Disable further swipe detection until touch ends
            }
        });

        homeIndicatorBar.addEventListener('touchend', () => {
            isSwipingUp = false;
            // If not swiped enough, potentially reset any visual feedback here
            // scoreOverlay.style.transform = 'translateY(100%)'; // If you added a dynamic transform in touchmove
        });

        homeIndicatorBar.addEventListener('touchcancel', () => {
            isSwipingUp = false;
        });
        
        // For mouse users, a simple click on the bar can open it
        homeIndicatorBar.addEventListener('click', showScoreOverlay);


        // Close overlay on click outside modal or Escape key
        scoreOverlay.addEventListener('click', (e) => {
            // Only close if clicking the background, not the modal itself
            if (e.target === scoreOverlay) { 
                hideScoreOverlay();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && scoreOverlay.classList.contains('visible')) {
                hideScoreOverlay();
            }
        });


        // Initial setup
        document.addEventListener('DOMContentLoaded', initializeCardStack);
    </script>
</body>
</html>