<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cartes Chinoises - Audio Local</title>
    <style>
        html, body {
            margin: 0; padding: 0; height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: white;
            font-family: Arial, sans-serif;
            overflow-x: visible;
        }
        body {
            flex-direction: column;
        }
        .container {
            position: relative;
            width: 400px;
            height: 400px;
            user-select: none;
        }
        .card {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            background: white;
            border: 2px solid black;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 5rem;
            z-index: 1;
        }
        .card.next {
            transform: scale(0.95);
            opacity: 0.3;
            z-index: 0;
        }
        .audio-zone {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 60px;
            height: 60px;
            background: lightgray;
            border-radius: 50%;
            z-index: 2;
            cursor: pointer;
            /* Ces lignes ont été retirées ou modifiées pour supprimer l'icône */
            /* display: flex; */
            /* justify-content: center; */
            /* align-items: center; */
            /* font-size: 2rem; */
            /* color: black; */
        }
        .buttons {
            margin-top: 30px;
            display: flex;
            gap: 40px;
        }
        button {
            width: 60px;
            height: 60px;
            font-size: 2rem;
            border-radius: 50%;
            border: 2px solid black;
            background: white;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="container" id="container">
        <div class="card current" id="cardCurrent">...</div>
        <div class="card next" id="cardNext">...</div>
        <div class="audio-zone" id="audioZone" title="Jouer l’audio"></div> </div>

    <div class="buttons">
        <button id="btnWrong" title="Je ne connais pas">✗</button>
        <button id="btnRight" title="Je connais">✓</button>
    </div>

    <script>
        const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQLhJumynOVacZQyjTJdfb2E03VOHW3FdlwYszFGHJcrOVWaihv-mrXDc3oegjTdFpJTobI1jN1nNpN/pub?gid=0&single=true&output=csv";

        let cards = [];
        let currentIndex = 0;
        let displayState = 0;

        const cardCurrent = document.getElementById("cardCurrent");
        const cardNext = document.getElementById("cardNext");
        const btnRight = document.getElementById("btnRight");
        const btnWrong = document.getElementById("btnWrong");
        const audioZone = document.getElementById("audioZone");

        let audio = new Audio();

        function parseCSV(text) {
            const lines = text.trim().split("\n");
            return lines.map(line => {
                const [character, pinyin, translation] = line.split(",");
                return {
                    character,
                    pinyin,
                    translation,
                    familiarity: 0
                };
            });
        }

        function displayCard(index, element) {
            if (cards.length === 0) {
                element.textContent = "Aucune carte";
                return;
            }
            const card = cards[index];
            if (displayState === 0) {
                element.textContent = card.character;
            } else if (displayState === 1) {
                element.textContent = card.pinyin;
            } else {
                element.textContent = card.translation;
            }
        }

        function refreshCards() {
            displayState = 0;
            displayCard(currentIndex, cardCurrent);
            cardNext.textContent = "...";
        }

        function weightedRandomIndex(cards) {
            const weights = cards.map(c => 6 - (c.familiarity || 0));
            const total = weights.reduce((a, b) => a + b, 0);
            let r = Math.random() * total;
            for (let i = 0; i < cards.length; i++) {
                if (r < weights[i]) return i;
                r -= weights[i];
            }
            return 0;
        }

        function nextCard(known) {
            if (known) {
                cards[currentIndex].familiarity = Math.min(cards[currentIndex].familiarity + 1, 5);
            } else {
                cards[currentIndex].familiarity = Math.max(cards[currentIndex].familiarity - 1, 0);
            }
            currentIndex = weightedRandomIndex(cards);
            refreshCards();
        }

        function playAudio() {
            console.log("--- playAudio() appelée ---");
            if (cards.length === 0) {
                console.log("Pas de cartes chargées, impossible de jouer l'audio.");
                return;
            }
            const character = cards[currentIndex].character;
            const audioUrl = "audios/" + encodeURIComponent(character) + ".mp3";
            console.log("URL audio générée :", audioUrl);

            audio.src = audioUrl;
            audio.load();
            audio.play().catch(err => {
                console.error("Erreur lors de la lecture de l'audio pour : " + character + " (URL: " + audioUrl + ")", err);
                alert("Pas de fichier audio pour : " + character + " (Erreur: " + err.name + ")");
            });
        }

        audioZone.addEventListener("click", playAudio);
        cardCurrent.addEventListener("click", () => {
            displayState = (displayState + 1) % 3;
            displayCard(currentIndex, cardCurrent);
        });

        btnRight.addEventListener("click", () => nextCard(true));
        btnWrong.addEventListener("click", () => nextCard(false));

        fetch(SHEET_CSV_URL)
            .then(r => r.text())
            .then(text => {
                cards = parseCSV(text);
                currentIndex = weightedRandomIndex(cards);
                refreshCards();
                console.log("Cartes chargées avec succès ! Première carte :", cards[currentIndex]);
            })
            .catch(err => {
                cardCurrent.textContent = "Erreur chargement données CSV";
                console.error("Erreur de chargement du CSV :", err);
            });
    </script>

</body>
</html>